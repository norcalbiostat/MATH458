---
title: "Cluster Sampling"
description: "Selecting groups at . Lohr Ch 5. "
author: DRAFT - 458 class
date: 3/20/23
execute: 
  error: true
  warning: false
  message: false
---

```{r}
library(here); library(tidyverse);library(knitr)
library(sampling); library(survey)
```

# Introduction


## Why use Cluster Sampling? 


------------------------------------------------------------------------

# One-Stage Clustering Sampling 

## Equal size clusters

* Each _psu_ has the same number of elements; $M_{i} = m_{i} = M$.
* Often can be found in agriculture or industrial sampling. 
* $t_{i}$ is the total for all elements in _psu_ $i$. 
* $t_{i}$ is known for sampled households, since data is collected on both individuals. (E.g. $Var(t_{i})=0$)

:arrow_right: Treat the _psu_ means or totals as observations, and ignore the individual elements. We now have an SRS of $n$ data points. 

Thus we can use the same SRS formulas to estimate the total and mean, **however** this is an SRS of $n$ _psu_'s, not an SRS of $nM$ observational units. So the $df$ needed to create a Confidence Interval is $n-1$. 

To estimate the population total $t$ or average $\mu$, we can use the following estimators and variances: 

$$
\hat{t} = \frac{N}{n}\sum_{i \in S}t_{i} \qquad 
s_{t}^{2} = \frac{1}{n-1}\sum_{i \in S}\Big(t_{i} - \frac{\hat{t}}{N}\Big)^2
$$

and 
$$
\hat{\bar{y}} = \frac{\hat{t}}{NM} \qquad
V(\hat{\bar{y}}) = \Big(1-\frac{n}{N}\Big)\frac{s^{2}_t}{nM^2}
$$

:::{.callout-tip icon=true}
### Estimate the income in a two person households

Consider individual incomes ($y_{ij}$) for each of $j=1,2$ persons in the 3 sampled households out of the 50 in the population. 

```{r}
hhi <- data.frame(
  household = c(1:3), 
  yi1 = c(37638, 69012, 30001), 
  yi2 = c(79999, 86753, 54321)
)
kable(hhi, align = 'c')
```
:::

First define our known values: N = 50, n = 3, M = 2. 

The total household income $t_i$ is calculated as the sum of the individual incomes within each cluster $\sum_j y_{ij}$. 

```{r}
hhi$ti <- hhi$yi1 + hhi$yi2
hhi
```

The estimated mean is
```{r}
t.hat <- (50/3)*sum(hhi$ti)
(ybar.hat <- t.hat / (50*2))
```

with variance
```{r}
s2.t <- (1/(3-1))*sum((hhi$ti - t.hat/50)^2)
(var.ybar.hat <- (1 - 3/50)*(s2.t/(3*2^2)))
```

Calculate CI. 
```{r}
crit.t <- qt(.975, 3-1)
ci.low.mu  <- ybar.hat - crit.t*sqrt(var.ybar.hat)
ci.hi.mu   <- ybar.hat + crit.t*sqrt(var.ybar.hat)
```

We can be 95% confident that the average population income for a household of two people is contained in the interval (`r scales::dollar(ci.low.mu, accuracy=1)`, `r scales::dollar(ci.hi.mu, accuracy=1)`. 


:::{.callout-warning icon=false}
### :star: You try it: Average GPA in a dorm

A student wants to estimate the average GPA in their dorm. Obtaining a listing of all students in the hall and conducting an SRS would take a lot of time. Instead, since each of the 100 suites in the hall have 4 students, the student randomly samples 5 suites and collects GPA data for each student in the suite. 

Using functions from the `sampling` package, estimate the average GPA for all students living in that dorm, with a proper 95% CI. Interpret your interval.

```{r}
gpa <- readr::read_csv(here::here("data", "gpa.csv"))
head(gpa)
```

The data was recorded in long format -- this is the format needed for analysis. The table in the book is formatted for human eyeball consumption, not for analysis. 
:::

1. Set the survey design. 
```{r}
gpa.design <- svydesign(id = ~suite,
                        weights = ~wt,
                        fpc=~rep(100,20),
                        data=gpa) 
```

2. Call `surveymean` and CI. 
```{r}
(dorm.gpa.mean <- svymean(~gpa, gpa.design))

(df <- degf(gpa.design)) # Extract degrees of freedom

confint(dorm.gpa.mean, level=.95, df=4)
```

We can be 95% confident that the average GPA for students living in this dorm is contained in the interval 2.37 to 3.28. 

