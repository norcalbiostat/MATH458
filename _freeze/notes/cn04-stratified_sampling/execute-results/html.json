{
  "hash": "493f216ba30d2ec4f05ece6af3004237",
  "result": {
    "markdown": "---\ntitle: \"Stratified Sampling\"\ndescription: \"A method to use additional information about the population in the survey design\"\nauthor: Sp'25 458 class\ndate: 3/29/25\nexecute: \n  error: true\n  warning: false\n  message: false\n---\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse);library(knitr)\nlibrary(sampling); library(survey)\n# Load data\nagpop <- read_csv(here::here(\"data\", \"agpop.csv\"))\nagstrat <- read_csv(here::here(\"data\", \"agstrat.csv\"))\n```\n:::\n\n\n![Source: https://www.scribbr.com/methodology/stratified-sampling/](https://www.scribbr.com/wp-content/uploads/2020/09/stratified-sample-7-2048x863.png)\n\n# What is Stratified Sampling \n\n::: callout-important\n#### Key Terms\n\n**Stratified sampling** is the method by which a population is broken into $H$ subgroups(strata). Independent SRS's are taken on each subgroup. Our samples are then polled to generate overall population estimates.\n\n**Strata** are subgroups of a population that do not intersect and add up to the whole population.\n:::\n\n## Why Use A Stratified Sample?\n\n1.  **You can protect against the possibility of a really bad sample with overrepresentation of a subpopulation.** Stratified Sampling guarantees set proportions of subpopulations in your sample. Example: You can ensure 50% male and 50% female in a sample.\n2.  **Stratified sampling means you can know the precision of the data collected for subgroups of the population.** Example: comparing experiences of male and female graduates when males vastly outnumber female graduates.\n3.  **Stratified sampling can be less costly or more convenient.** You can use different sampling frames, designs, or field procedures for different strata. Example: You could use mail, email, telephone, or internet surveys based on what works best for each subpopulation\n4.  **This method has lower variance estimates for population means and totals making it more precise than an SRS.** This is demonstrated using a motivating example next.\n\n::: {.callout-tip icon=\"true\"}\n### Motivating Example - Estimating farm details.\n\nDuring the colonial period of the United States travel was limited and most of the population lived on the East coast. The states are small in size, the population denser, and thus the farmland is smaller. In the 1800's the US \"acquired\" the western half of the US in large patches. This led to much larger farmland, owned by fewer individuals.\n\nThe distribution of farm acreage in 1992 for each region is summarized below.\n:::\n\n::: columns\n::: {.column width=\"60%\"}\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\n# Mutate data to create names for levels and labels in boxplot\nagstrat.plot <- agstrat %>%\n  mutate(\n    region_factor = factor(\n      region,\n      levels = c(\"NE\", \"S\", \"NC\", \"W\"),  \n      labels = c(\"Northeast\", \"South\", \"North Central\", \"West\")\n    ),\n    acres_million = acres92/1e6 # convert acres to millions\n  )\n  \nggplot(agstrat.plot, aes(x = region_factor, y = acres_million)) +\n  stat_boxplot(geom = \"errorbar\", linetype = \"solid\", width = 0.5) +\n  geom_boxplot(outlier.shape = 1, outlier.size = 3) +\n  coord_cartesian(ylim = c(0, 2.5)) +\n  labs(\n    x = \"Region\",\n    y = \"Millions of Acres\"\n  ) +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![Figure 3.1: Distribution of farm acreage in 1992 by region](cn04-stratified_sampling_files/figure-html/unnamed-chunk-2-1.png){width=576}\n:::\n:::\n\n:::\n\n::: {.column width=\"40%\"}\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nagstrat %>% group_by(region) %>%\n  summarise(sample.average = mean(acres92), \n            sample.variance = var(acres92)) %>%\n  kable()\n```\n\n::: {.cell-output-display}\n|region | sample.average| sample.variance|\n|:------|--------------:|---------------:|\n|NC     |      300504.16|     29618183543|\n|NE     |       97629.81|      7647472708|\n|S      |      211315.04|     53587487856|\n|W      |      662295.51|    396185950266|\n:::\n:::\n\n:::\n:::\n\nEach region has its own box plot we can compare. Each with a marked median (the thick solid line), the 25th and 75th percentiles marked by the edges of the box and its outliers. Each of the regions (except the West) tend to have quite a few high-end outliers (aka positively skewed). The NE region has the smallest average farm size (9.7k acres) and the smallest variance (7.6B) whereas the west has quite a large variance (396B) and mean(622k)\n\nTo properly estimate the average size of a farm, or the total number of farms, we want to ensure our sample is representative of the population. A SRS may end up oversampling small farms from the east and missing out on larger farms from the west. This is why we considered stratification for this example.\n\n::: {.callout-warning icon=\"false\"}\n### You try it.\n\nExplore the distribution of farm acreage in 1982 by region. Create a table of summary statistics and a boxplot. Discuss your findings.\n:::\n\n::: {.callout-warning icon=\"false\" collapse=\"true\" appearance=\"minimal\"}\n### Solution\n:::\n\n::: {.callout-tip icon=\"true\"}\n## Example: Estimating the total acerage of farmland.\n\nThe data contained in `agstrat.csv` comes from a is stratified sample across four regions of the United States: Northeast, North Central, South, and West.\n\nUsing this stratified sample, estimate the total number of acres of farmland in the United States in 1992 by calculating the within strata totals, and then combining across strata.\n:::\n\nSince we took an SRS in each stratum, we estimate the population total within each stratum using $\\hat{t} = N\\bar{y}$ and $\\hat{V}(\\hat{\\tau}) = N^{2}\\hat{V}(\\bar{y})=N^{2}(1 - \\frac{n}{N})\\frac{s^{2}}{n}$ within each strata.\n\nFor example to estimate the total number of acres devoted to farms in the Northeast,\n\n\n::: {.cell}\n\n```{.r .cell-code}\n220*97629.81\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 21478558\n```\n:::\n:::\n\n\nwith estimated variance\n\n\n::: {.cell}\n\n```{.r .cell-code}\n220^2*(1-21/220)*(7647472708)/21\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 1.594316e+13\n```\n:::\n:::\n\n\nLohr table 3.2 gives *estimates* of the total number of farm acres, $\\hat{t}_{h}$, and estimated variance of the total, $\\hat{V}(\\hat{t}_{h})$, for each of the $h=4$ strata. Knowing this is an important key detail that shows us that the overall variance of the estimate is reduced by having the regions broken up into strata. This table also shows that if used efficiently, less samples are needed with stratified sampling to achieve the same, it not better, precision. In regards to the farm acres, this table highlights the variability in sizes of farms and area used for farm land in each stratum.\n\n## Gain from stratification\n\nObservations within strata are more similar to each other, than they are to the population as a whole. A reduction in variance in individual strata can lead to a reduced variance for the population estimate.\n\n::: callout-important\n### Definition: Relative gain from stratification\n\nThe reduction in variance from using a stratified sample compared to a SRS.\n:::\n\nThis is estimated by the ratio:\n\n$$\n\\frac{\\mbox{estimated variance from stratified sample}}{\\mbox{estimated variance from SRS}}\n$$\n\nUsing the farm example,\n\n$$\\frac{2.5419 * 10^{15}}{3.3837 * 10^{15}} =0.75 $$\n\nThe variance is reduced by 75% from the method of stratified sampling method compared to the SRS method.\n\n# Theory of Stratified Sampling \n\nThe formulas presented in this section are summarized in a table on the [formulas page](https://sampling-458.netlify.app/formulas#stratified-random-sample).\n\n## Notation\n\n-   $n$ - total sample size, from all strata\n-   $N$ - total population size, from all strata\n-   $y_{hj}$ - value of the $j^{th}$ unit in stratum $h$\n-   $H$ - total number of strata\n\n| Measure on stratum $h$  | Population | Statistic   |\n|-------------------------|------------|-------------|\n| number of units         | $N_{H}$    | $n_h$       |\n| total (sum of $y_{hj}$) | $t_h$      | $\\hat{t}_h$ |\n| mean of $y_{hj}$        | $\\mu_{h}$  | $\\bar{y}_h$ |\n| variance of $y_{hj}$    | $S^2_h$    | $s^2_h$     |\n| proportion of event     | $p_h$      | $\\hat{p}_h$ |\n\n## Estimators for Population Parameters\n\nThe estimators for the population parameters are the sum (or weighted sum) of the strata level estimators. Since an SRS was taken within each strata, $\\hat{\\tau}_{str}$ and $\\bar{y}_{str}$ are unbiased estimators of $\\tau$ and $\\mu$ respectively.\n\n-   $\\hat{\\tau}_{str} = \\sum_{h}\\hat{\\tau}_{h}$ - the estimate for $t$, the total for the entire population\n-   $\\bar{y}_{str} = \\sum_{h} \\frac{N_{h}}{N}\\bar{y}_{h}$ - the estimate for $\\mu$, the overall population mean. This is the weighted average of the sample stratum means.\n-   $\\hat{p}_{str} = \\sum_{h}\\frac{N_{h}}{N}\\hat{p}_{h}$ - the estimated overall population proportion $p$\n\n## Variance of overall estimators\n\nSince the SRS's within each strata are taken independently, the variances within each strata are mutually independent. Thus the estimated variance for the populations estimates are calculated by summing up (over the $H$ layers), the individual strata variances.\n\n-   $\\hat{V}(\\hat{\\tau}_{str}) = \\sum_{h} \\hat{V}(\\hat{\\tau}_{h})$ - the estimate for the variance of the estimate of the population total found by substituting the sample variances for the population variances.\n-   $\\hat{V}(\\bar{y}_{str}) = \\frac{1}{N^2}\\hat{V}(\\hat{\\tau}_{str})$ - the estimate for the variance of the estimate of the population mean found by substituting the sample variances for the population variances.\n-   $\\hat{V}(\\hat{p}_{str}) = \\sum_{h} (1-\\frac{n_h}{N_h})\\big(\\frac{N_{h}}{N}\\big)^2\\Big(\\frac{\\hat{p}_h(1-\\hat{p}_h)}{n_h-1}\\Big)$ - the estimated variance of the estimated overall population proportion\n\nThe *standard errors* for these estimators are the square roots of their estimated variances. By substituting our sample variances for population variances, that is $s_h$ for $S_h$, we can obtain unbiased estimators of the variances.\n\n## Confidence Intervals\n\n**Confidence intervals for stratified samples** Conditions for formula to be valid: either (1) the sample sizes within EACH stratum are large, or (2) there is a large number of strata\n\n100(1- $\\alpha$)% confidence interval is given by: $$\\bar{y}_{str} \\pm z_{\\alpha/2} * SE(\\bar{y}_{str})$$ However, most survey packages use a $t_{n-H}$ distribution instead of using the normal assumption.\n\n## Strata level estimates\n\n| Measure on stratum $h$ | Estimate                                       | Variance                                                                 |\n|------------------------|-------------------|---------------------------|\n| total                  | $\\hat{\\tau}_{h} = N_{h}\\bar{y_h}$              | $\\hat{V}(\\hat{\\tau}_{h}) = (1-\\frac{n_h}{N_h})N_{h}^2 \\frac{s^2_h}{n_h}$ |\n| mean                   | $\\bar{y}_{h} = \\frac{1}{n_{h}}\\sum_{j} y_{hj}$ | $\\hat{V}(\\bar{y}_{h}) = \\frac{1}{N^2}V(\\hat{\\tau}_{h})$                  |\n| proportion             | $\\hat{p}_{h} = \\bar{y}_{h}$                    | $\\hat{V}(\\hat{p}_{h}) = (\\frac{n_h}{n_h-1})\\hat{p}_h(1-\\hat{p}_h)$       |\n\n::: {.callout-tip icon=\"true\"}\n### Example: Estimate the total number of farm acres in 1992 (Table 3.2)\n\nEstimate the total number of acres of farmland in the United States in 1992 by calculating the within strata totals, and then combining across strata.\n:::\n\n1.  Calculate summary statistics for each region.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstrata.summary.stats <- agstrat %>% \n   group_by(region) %>% \n   summarize(y.bar.h = mean(acres92),\n             s2.h    = var(acres92),\n             n.h     = n()) \nstrata.summary.stats\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 4 × 4\n  region y.bar.h          s2.h   n.h\n  <chr>    <dbl>         <dbl> <int>\n1 NC     300504.  29618183543.   103\n2 NE      97630.   7647472708.    21\n3 S      211315.  53587487856.   135\n4 W      662296. 396185950266.    41\n```\n:::\n:::\n\n\n2.  Calculate Population region sizes, add this vector to the data frame created above.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntable(agpop$region) ## number of farms by region \n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n  NC   NE    S    W \n1054  220 1382  422 \n```\n:::\n\n```{.r .cell-code}\nstrata.summary.stats$N.h = c(1054,220,1382,422) \nstrata.summary.stats ##added as column \n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 4 × 5\n  region y.bar.h          s2.h   n.h   N.h\n  <chr>    <dbl>         <dbl> <int> <dbl>\n1 NC     300504.  29618183543.   103  1054\n2 NE      97630.   7647472708.    21   220\n3 S      211315.  53587487856.   135  1382\n4 W      662296. 396185950266.    41   422\n```\n:::\n:::\n\n\n3.  Calculate the within strata sample total: $\\hat{\\tau}_{h} = N_{h}\\bar{y_h}$\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstrata.summary.stats$t.h <- strata.summary.stats$y.bar.h*strata.summary.stats$N.h \n\nstrata.summary.stats\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 4 × 6\n  region y.bar.h          s2.h   n.h   N.h        t.h\n  <chr>    <dbl>         <dbl> <int> <dbl>      <dbl>\n1 NC     300504.  29618183543.   103  1054 316731380.\n2 NE      97630.   7647472708.    21   220  21478558.\n3 S      211315.  53587487856.   135  1382 292037391.\n4 W      662296. 396185950266.    41   422 279488706.\n```\n:::\n:::\n\n\n4.  Calculate the within-strata variance of this total $$\\sum_{h=1}^{H} V(\\hat{t}_h) = \\sum_{h=1}^{H} \\left( 1 - \\frac{n_h}{N_h} \\right)N_{h}^2 \\frac{S_h^2}{n_h}$$\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstrata.summary.stats$V.t <- ((1 - (strata.summary.stats$n.h/strata.summary.stats$N.h))*(strata.summary.stats$N.h^2)*\n(strata.summary.stats$s2.h)/strata.summary.stats$n.h)\n\nstrata.summary.stats\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 4 × 7\n  region y.bar.h          s2.h   n.h   N.h        t.h     V.t\n  <chr>    <dbl>         <dbl> <int> <dbl>      <dbl>   <dbl>\n1 NC     300504.  29618183543.   103  1054 316731380. 2.88e14\n2 NE      97630.   7647472708.    21   220  21478558. 1.59e13\n3 S      211315.  53587487856.   135  1382 292037391. 6.84e14\n4 W      662296. 396185950266.    41   422 279488706. 1.55e15\n```\n:::\n:::\n\n\n5.  Calculate the overall total and variance by summing these values across the strata.\n\n$$\\hat{\\tau}_{str} = \\sum_{h}\\hat{\\tau}_{h}, \\qquad \\mbox{ and } \\qquad \\hat{V}(\\hat{t}_{str}) = \\sum_{h=1}^{H} V(\\hat{t}_h)$$\n\n\n::: {.cell}\n\n```{.r .cell-code}\n(total.sum <- sum(strata.summary.stats$t.h)) \n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 909736035\n```\n:::\n\n```{.r .cell-code}\n(total.var <- sum(strata.summary.stats$V.t))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 2.541899e+15\n```\n:::\n:::\n\n::: {.cell}\n\n:::\n\n\n::: {.callout-warning icon=\"false\"}\n### You try it\n\nEstimate the total number of caribou...\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncaribou <- data.frame(\n  Stratum = c(\"A\", \"B\", \"C\", \"D\", \"E\", \"F\"), \n  N.h = c(400, 30, 61, 18, 70, 120), \n  n.h = c(8, 10, 37, 6, 39, 21), \n  y.bar.h = c(24.1, 25.6, 267.6, 179, 293.7, 33.2), \n  s2.h = c(5575, 4064, 347556, 22798, 123578, 9795))\n```\n:::\n\n:::\n\n# Sampling Weights \n\n## How are weights calculated?\n\n* The sampling weight for an observation is the reciprocal of its probability of inclusion.\n* The probability of inclusion for a unit in a stratum is calculated as the sample size divided by the total number of units in that stratum.\n\n$$w_{hj}=\\frac{N_h}{n_h}$$\n\nThe sum of the weights will equal the population size. \n\n$\\sum_h\\sum_jw_{hj}=N$\n\n## How are weights used?\n\nThe stratified sampling estimator of the total population is expressed as the sum of weighted observations across all strata.\n\n$$\\hat{t}_{str}=\\sum_h\\sum_jw_{hj}y_{hj}$$\n\n* apply weights to observations\n* inner sum is within strata\n* outer sum is across strata\n\nThe population mean-average of the observations weighted by strata.\n\n$$\\bar{y}_{str}=\\frac{\\sum_h\\sum_jw_{hj}y_{hj}}{\\sum_h\\sum_jw_{hj}}$$\n\n\n::: {.callout-tip icon=\"true\"}\n### Example: Re-Estimate the total number of farm acres in 1992 using sample weights\n\nWe\n\n::: {.cell}\n\n```{.r .cell-code}\nagstrat$acreswt <- agstrat$acres92 * agstrat$strwt\nsum(agstrat$acreswt)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 909736036\n```\n:::\n:::\n\n\n:::\n\n::: {.callout-warning icon=\"true\"}\n### You try it Caribou weights\n\n\n:::\n\n------------------------------------------------------------------------\n\n# Allocation Methods\n\n::: callout-important\n### Method 1: Proportional Allocation\n\nIn proportional allocation, the number of units sampled in each stratum is proportional to the size of each stratum. The inclusion probability of each unit $j$ in each stratum $h$ is equal.\n\n$$\\pi_{hj} = \\frac{n_{h}}{N_{h}} = \\frac{n}{N}$$\n:::\n\n\n::: callout-important\n### Method 2: Optimal Allocation\n\nIn optimal allocation, the number of sampled units in each stratum is based on minimizing variance for the cost.\n\nThe sampled units in each stratum can be determined using the equation\n\n$$n_{h} = (\\frac{\\frac{N_{h}s_{h}}{\\sqrt{c_{h}}}}{\\sum\\limits_{l = 1}^{H}\\frac{N_{l}s_{l}}{\\sqrt{c_{l}}}})n$$\n\nwhere $c_{h}$ is the cost of stratum h and $c_{l}$ is the cost of stratum l.\n\nNeyman Allocation is a case of Optimal Allocation where all costs are approximately equal, represented by \n\n$$n_{h} = (\\frac{N_{h}s_{h}}{\\sum\\limits_{l = 1}^{H}N_{l}s_{l}})n$$\n\n:::\n\n\n::: callout-important\n### Method 3: Allocation for Specified Precision within Strata\n\n**What is it?** When allocating with a specific precision in mind the idea is that you want to compare the means and totals within different strata. \n\n**How is this method different?** This is different from proportional allocation in the sense that you do not take population size into account when giving each strata the same sample size.  This is also different from optimal allocation since it does not minimize variance for the total estimate. \n:::\n\n\n\n::: {.callout-tip icon=\"true\"}\n### Example: Calculating Allocations for a Survey of Colleges\nSuppose we are interested in taking a survey of US colleges and universities.\n\nWe can make the assumption that the primary variables we are interested in studying in this survey, such as total instructional budget, or number of students employed full time five years after graduation, are related to the size of the institution.\n\nThe `college.csv` dataset contains 1,372 US colleges and universities. One such variable categorizes institutions by size and residential status. We can stratify by this variable, combining all \"Very small\" institutions into one strata.\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\nframe <- readr::read_csv(here::here(\"data\", \"college.csv\"))\nframe <- frame %>% arrange(ccsizset)\n# create a strata column that labels all very small institutions by the same label\nframe$strata<- frame$ccsizset\nidx <- frame$ccsizset < 8\nframe$strata[idx] <- 8\n```\n:::\n\n\nFind the size of each stratum\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstrata.info<-as.data.frame(table(frame$strata))\ncolnames(strata.info)<- c(\"Stratum\", \"N_h\")\n\nstrata.info\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n   Stratum N_h\n1        8 195\n2        9  45\n3       10 123\n4       11 347\n5       12  80\n6       13 160\n7       14 158\n8       15  95\n9       16 126\n10      17  43\n```\n:::\n:::\n\n\nWe do not know the variances of the variables to be studied, but we can assume that they will be roughly proportional to the variances of `ugds`, the number of undergraduate students at the institution. We can calculate the variances of each strata and use them to calculate the Neyman allocations of each strata.\n\nFind the sample strata means $\\bar{y}$ and standard deviations $s$. \n\n* Code method 1\n\n::: {.cell}\n\n```{.r .cell-code}\nstrata.means<- rep(0,10)\nfor (i in 1:10) {\n  strata.means[i]<-mean(frame$ugds[frame$strata == strata.info$Stratum[i]])\n}\nstrata.means\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n [1]   639.2359  2004.0222  1611.6911  1639.4957  5926.6875  5274.7937\n [7]  4095.6266 21566.9263 18730.0238 11771.7209\n```\n:::\n\n```{.r .cell-code}\n# Calculating S_h (within stratum standard deviation)\nfor (i in 1:10) {\n  ssq <- sum((frame$ugds[frame$strata == strata.info$Stratum[i]]-strata.means[i])^2)\n  strata.info$S_h[i] <- round(sqrt(ssq*(1/(strata.info$N_h[i]-1))))\n}\nstrata.info$S_h\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n [1]   251   784   515   508  2490  2150  1473 11273  9178  6844\n```\n:::\n:::\n\n\n* Code method 2\n\n::: {.cell}\n\n```{.r .cell-code}\nframe %>% group_by(strata) %>% summarize(mean_ugd = mean(ugds), \n                                         s_ugd = sd(ugds))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 10 × 3\n   strata mean_ugd  s_ugd\n    <dbl>    <dbl>  <dbl>\n 1      8     639.   251.\n 2      9    2004.   784.\n 3     10    1612.   515.\n 4     11    1639.   508.\n 5     12    5927.  2490.\n 6     13    5275.  2150.\n 7     14    4096.  1473.\n 8     15   21567. 11273.\n 9     16   18730.  9178.\n10     17   11772.  6844.\n```\n:::\n:::\n\n\nWe want to take a sample size of 200. For finding the Neyman allocations, we will use the formula $n*\\frac{N_hS_h}{\\sum_{l} N_lS_l }$ and round to whole numbers\n\n\n::: {.cell}\n\n```{.r .cell-code}\nSample_size <- 200\nd <- sum(strata.info$N_h*strata.info$S_h)\nstrata.info$Neyman<- round(Sample_size*(strata.info$N_h*strata.info$S_h/d))\nstrata.info$Neyman\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n [1]  3  2  3 10 11 19 13 59 64 16\n```\n:::\n:::\n\n\nFor finding the Proportional allocations we will use the formula $n*\\frac{N_h}{N}$\nand round to the nearest whole number\n\n\n::: {.cell}\n\n```{.r .cell-code}\nN<- sum(strata.info$N_h)\nstrata.info$Proportional<- round(Sample_size*(strata.info$N_h/N))\nstrata.info$Proportional\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n [1] 28  7 18 51 12 23 23 14 18  6\n```\n:::\n:::\n\n\nComparing them all: \n\n::: {.cell}\n\n```{.r .cell-code}\n# We can edit the stratum names to be more readable\nstrata.info$Stratum <- c(\"Very small\", \"Small, primarily nonresidential\", \"Small, primarily residential\", \"Small, highly residential\",  \"Medium, primarily nonresidential\", \"Medium, primarily residential\", \"Medium, highly residential\", \"Large, primarily nonresidential\", \"Large, primarily residential\", \"Large, highly residential\")\n\n\nstrata.info %>% janitor::adorn_totals() %>% kable()\n```\n\n::: {.cell-output-display}\n|Stratum                          |  N_h|   S_h| Neyman| Proportional|\n|:--------------------------------|----:|-----:|------:|------------:|\n|Very small                       |  195|   251|      3|           28|\n|Small, primarily nonresidential  |   45|   784|      2|            7|\n|Small, primarily residential     |  123|   515|      3|           18|\n|Small, highly residential        |  347|   508|     10|           51|\n|Medium, primarily nonresidential |   80|  2490|     11|           12|\n|Medium, primarily residential    |  160|  2150|     19|           23|\n|Medium, highly residential       |  158|  1473|     13|           23|\n|Large, primarily nonresidential  |   95| 11273|     59|           14|\n|Large, primarily residential     |  126|  9178|     64|           18|\n|Large, highly residential        |   43|  6844|     16|            6|\n|Total                            | 1372| 35466|    200|          200|\n:::\n:::\n\n\nWe can see that both allocations take a sample of 200 out of 1372 schools\n\n\n## Which allocation to use?\n\n* **Proportional Allocation:** The best choice if you intend to have a \"miniature version\" of your population. The weight is the same for every unit of *N/n*, hence the stratum sample size is proportional to its population size. They typically have smaller variances than those similar estimates of an SRS. \n\n* **Disproportional Allocation:**  The best choice if you want your strata to be oversampled to achieve specific goals within sampling. This may be to ensure certain things like a specific precision or increase representation of different variance groups. \n\n* **Neyman Allocation:** The best choice when you have certain strata with higher variances and want to oversample those to reduce the overall variance. Can (but not always) improve precision for specifically chosen variables. \n\nThere is no one specific method that is always the best. What you want from and how you intend to analyze your samples will help you to determine what method works best for you, or which combination/hybrid of methods. \n\n\n::: {.callout-warning icon=\"false\"}\n## You try it: Explore Neyman Allocation in the Caribou Survey.\n\nThe investigators used their findings to create a stratification that has a relatively homogeneous population density with the total sample size of *225 caribou*. These investigators used the Neyman allocation to calculate the stratum as an approximate of the standard deviation, and to have the sampling fraction be $\\frac{1}{3}$ smaller in strata.\n\nCalculate the $n_h$ using Neyman allocation and compare to their chosen strata sample sizes.\n:::\n\n\n\n\n# Selecting Strata \n\n### Defining Strata\n\nStratified sampling, as we've learned, improves the precision for every variable measured in a survey, and is almost always better from a variance standpoint than an SRS. \n\nIdeally for a stratified sample, we would stratify by the values of y, but we don't exactly know what the exact values of y are, so we use variables that are closely related to it. For example, if we're trying to determine farm income, we may use the size of said farm as a stratifying variable.\n\nUsing Example 3.13, in order to estimate the number of homeless people in certain regions, surveyors choose one night to conduct a count of people staying on streets, in bus-stops, subway stations, etc. And also survey people in emergency shelter or transition housing. Getting further into the example- we're assuming that the survey is done in New York City. The area of the city is much too large to survey in one night, so the city is split up into \"high-density\" and \"low-density\" areas. This results in 12 strata by having one high-density and one low-density stratum for each borough, and also for the subway system. This sampling design allows New York City to obtain the necessary data in just one night with roughly 2,000-2,500 volunteer surveyors, and allows for a statistically valid estimate.\n\n### How Many Strata?\n\n::: {.callout-tip icon=\"true\"}\n### Example: Estimating homeless population from NYC\n\nBackground: In the United States, state and local agencies are responsible for coordinating homeless services annually estimate the number and characteristics of individuals experiencing homelessness within their regions. Each agency selects one of the last ten nights in January to conduct the counts of both sheltered and unsheltered populations at that specific point in time. These surveys (refered to as \"Picture in Time\") are typically conducted on single nights to minimize the risk of double-counting and reduce the effort required for the teams of volunteers who canvass to survey the unsheltered population. \n:::\n\nIt is imperative to develop sampling plans that provide the most accurate estimates of the unsheltered population’s size possible and those enabling us to have contact with as many unsheltered individuals in the region as feasible.\n\nDue to reasons such as the impossible task of visiting every location in a large city neighborhoods during a single night, cost of performing such task, and also the difference in population levels, designing a survey which fits our goals will be seen to influence how we defined our strata by using separation of these area. \n\n\nBelow is a summary table for a stratified sample from the `pitcount.csv` file, which mimics the NYC homelessness sample design in example 3.13 of the book. This however is not the data for NYC homelessness, rather that of a fictional city.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npitdta <- readr::read_csv(here::here(\"data/pitcount.csv\"))\n\npitdta %>% select(strat, division, density, popsize, sampsize) %>%\n  unique() %>% kable()\n```\n\n::: {.cell-output-display}\n| strat| division|density | popsize| sampsize|\n|-----:|--------:|:-------|-------:|--------:|\n|     1|        1|High    |      12|       12|\n|     2|        2|High    |       8|        8|\n|     3|        3|High    |       4|        4|\n|     4|        4|High    |      16|       16|\n|     5|        1|Low     |     384|       24|\n|     6|        2|Low     |     192|       12|\n|     7|        3|Low     |     240|       15|\n|     8|        4|Low     |     144|        9|\n:::\n:::\n\n\nHere we see a total of 8 strata defined by both area (Divisions) and density levels inside of the areas. The first was done as various Divisions have different homelessness totals as per differences in social-economic factors within these areas also impact the homelessness in these divisions. In this study, we see the simultaneous stratification of areas based on density levels along this. This probably was done to make sure that we would be able to account for potential higher homelessness rates in densely populated areas as opposed to low density areas.\n\nAnother choice to notice is that high density areas were seen as a priority to gather information on in sample, therefore for our strata, we used the full populations in these areas(high density by divisions). Low density areas were proportionally allocated.\n\n\n------------------------------------------------------------------------\n\n# Using R\n\n## Selecting a Stratified Random Sample\n\n### Using the `strata` function from the `sampling` package\n\n1.  Sort the data by the stratification variable\n\n\n::: {.cell}\n\n```{.r .cell-code}\nagpop.sorted <- agpop %>% arrange(region)\n```\n:::\n\n\n2.  Specify the desired within-strata sample sizes $n_{k}$.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nn.k <- c(103, 21, 135, 41)\n```\n:::\n\n\n3.  Create the sampling index of records to select using the `strata` function with arguments specifying the strata names, strata size, and sampling method within strata.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstrat.idx <- sampling::strata(data = agpop.sorted, \n                              stratanames = \"region\", \n                              size = n.k, method = \"srswor\")\n```\n:::\n\n\n:::{.callout-important}\n#### Warning: Package conflicts\n\nPackage conflicts can occur with the `strata` function. If it is not working for you, use the `sampling::strata` method of calling the function to ensure you are using the correct version of the `strata` function from the `sampling` package.\n:::\n\n4.  Extract the data records that correspond to the sampling index.\n\n::: {.cell}\n\n```{.r .cell-code}\nag.str <- getdata(agpop.sorted, strat.idx)\nhead(ag.str)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n               county state acres92 acres87 acres82 farms92 farms87 farms82\n2        ADAMS COUNTY    IA  239800  243607  254071     643     688     737\n7   BLACK HAWK COUNTY    IA  299502  305516  308845    1111    1269    1352\n11 BUENA VISTA COUNTY    IA  341923  358798  361120     972    1097    1185\n24    CRAWFORD COUNTY    IA  415104  406895  426523    1260    1339    1511\n51   JEFFERSON COUNTY    IA  227073  234816  247992     740     775     894\n83      SHELBY COUNTY    IA  353570  351387  356831    1088    1177    1317\n   largef92 largef87 largef82 smallf92 smallf87 smallf82 region ID_unit\n2        38       32       21       40       50       33     NC       2\n7        49       34       27      116      152      154     NC       7\n11       38       30       21       96       81       75     NC      11\n24       61       45       33       87      120       92     NC      24\n51       38       30       28       55       41       54     NC      51\n83       41       29       16      105       99       99     NC      83\n         Prob Stratum\n2  0.09772296       1\n7  0.09772296       1\n11 0.09772296       1\n24 0.09772296       1\n51 0.09772296       1\n83 0.09772296       1\n```\n:::\n:::\n\n\n5.  Calculate the sampling weights using the inclusion probabilities (these were created as the variable `Prob` when you used the `strata` function)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nag.str$wt <- 1/ag.str$Prob\nhead(ag.str)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n               county state acres92 acres87 acres82 farms92 farms87 farms82\n2        ADAMS COUNTY    IA  239800  243607  254071     643     688     737\n7   BLACK HAWK COUNTY    IA  299502  305516  308845    1111    1269    1352\n11 BUENA VISTA COUNTY    IA  341923  358798  361120     972    1097    1185\n24    CRAWFORD COUNTY    IA  415104  406895  426523    1260    1339    1511\n51   JEFFERSON COUNTY    IA  227073  234816  247992     740     775     894\n83      SHELBY COUNTY    IA  353570  351387  356831    1088    1177    1317\n   largef92 largef87 largef82 smallf92 smallf87 smallf82 region ID_unit\n2        38       32       21       40       50       33     NC       2\n7        49       34       27      116      152      154     NC       7\n11       38       30       21       96       81       75     NC      11\n24       61       45       33       87      120       92     NC      24\n51       38       30       28       55       41       54     NC      51\n83       41       29       16      105       99       99     NC      83\n         Prob Stratum       wt\n2  0.09772296       1 10.23301\n7  0.09772296       1 10.23301\n11 0.09772296       1 10.23301\n24 0.09772296       1 10.23301\n51 0.09772296       1 10.23301\n83 0.09772296       1 10.23301\n```\n:::\n:::\n\n\n5b. Check that the sampling weights sum to the stratum population sizes.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nag.str %>% group_by(region) %>% summarize(sum.wts = sum(wt))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 4 × 2\n  region sum.wts\n  <chr>    <dbl>\n1 NC        1054\n2 NE         220\n3 S         1382\n4 W          422\n```\n:::\n\n```{.r .cell-code}\ntable(agpop.sorted$region)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n  NC   NE    S    W \n1054  220 1382  422 \n```\n:::\n:::\n\n\n:::{.callout-important}\n#### Trust but verify\n\nIf the weights do not sum to the stratum population sizes, you have made a mistake somewhere in the calculations for the weights or strata sizes.\n:::\n\n\n------------------------------------------------------------------------\n\n## Computing Statistics from a Stratified Random Sample\n\n\n::: {.callout-tip icon=\"true\"}\n### Example: Farmland in 1992\n\nThe book's provided `agstrat` data set is a stratified random sample with proportional allocation. Let's re-estimate the total amount of farmland in 1992 using the `survey` package.\n:::\n\n### 1. Setup the information for the survey design.\n\n#### a. Specify weights\n\nThe weights are contained in a variable called `strwt`. By comparing our generated weights from the last step to these, we can confirm that desired within-strata sample sizes $n_{k}= (103, 21, 135, 41)$ were based on a proporional allocation method. \n\n\n#### b. Specify fpc\n\nWe need to create a vector of fpc's that are equal to the strata population size. In a SRS, we used `fpc = rep(N,n)`. This create a vector that contains the value `N`, repeated `n` times. In this case, we need to match the strata population size to each record from that strata.\n\n**Option 1**\nCreate a vector that repeats the population sample sizes (`N.k`), each (`n.k` times - for each strata k. Recall that in this example we can calculate the stratum population sizes from the `agpop` data. However in real life, you likely will have to get these numbers in another manner. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nN.k <- agpop.sorted %>% group_by(region) %>% tally() \nagstrat$popsize_option1 <- rep(N.k$n, n.k)\n# trust but verify \ntable(agstrat$popsize_option1, agstrat$region)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n      \n        NC  NE   S   W\n  220    0  21   0   0\n  422    0   0   0  41\n  1054 103   0   0   0\n  1382   0   0 135   0\n```\n:::\n:::\n\n\n**Option 2** \nCreate a data frame with the population sizes and merge it onto the data frame using the strata variable as the joining key\n\n\n::: {.cell}\n\n```{.r .cell-code}\npopsize.dta <- data.frame(region = c(\"NC\", \"NE\", \"S\", \"W\"),\n                          popsize = c(1054, 220, 1382, 422))\nagpop.str <- agstrat %>% left_join(popsize.dta)\ntable(agpop.str$popsize, agpop.str$region)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n      \n        NC  NE   S   W\n  220    0  21   0   0\n  422    0   0   0  41\n  1054 103   0   0   0\n  1382   0   0 135   0\n```\n:::\n:::\n\n\n### 2. Call `svydesign`\n\n\n::: {.cell}\n\n```{.r .cell-code}\nagpop.str.dsgn <- svydesign(id = ~1, \n                            strata = ~region, \n                            weights = ~strwt, \n                            fpc = ~popsize, # this uses option 2\n                            data= agpop.str)\n```\n:::\n\n\n### 3. Calculate total, SE and CI\n\nNote the degrees of freedom for a CI under a stratified sample is $n-H$, which can be extracted from the `svydesign` object using the `degf` function.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n(str.total <- svytotal(~acres92, agpop.str.dsgn))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n            total       SE\nacres92 909736036 50417248\n```\n:::\n\n```{.r .cell-code}\nconfint(str.total, level = .95, df = degf(agpop.str.dsgn))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n            2.5 %     97.5 %\nacres92 810514350 1008957721\n```\n:::\n:::\n\n\n\n::: {.callout-tip icon=\"true\"}\n## Calculating stratum means and variances\n\nInstead of using the formulas as shown in Ch 3.3, we can use the `svyby` function.\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\nregional.totals <- svyby(~acres92, by=~region, agpop.str.dsgn, \n                         svytotal, keep.var = TRUE)\nkable(regional.totals)\n```\n\n::: {.cell-output-display}\n|   |region |   acres92|       se|\n|:--|:------|---------:|--------:|\n|NC |NC     | 316731380| 16977399|\n|NE |NE     |  21478558|  3992889|\n|S  |S      | 292037392| 26154840|\n|W  |W      | 279488706| 39416342|\n:::\n:::\n\n\nConfirm the overall total $\\hat{\\tau}_{str}$ by summing these values across the strata.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsum(regional.totals$acres92)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 909736036\n```\n:::\n:::\n\n\n\n::: {.callout-warning icon=\"false\"}\n### Estimating vehicle information for the entire USA.\n\nThe Vehicle Inventory and Use Survey (VIUS) used is the result of a a stratified random sampling design that collects information on the number of private and commercial trucks in each state.\n\nIn the 2002 survey, 255 strata (51 \\* 5) were created from truck registrations among the 51 states and 5 truck types. Within each state (+DC),the truck registrations were partitioned into one of five classes:\n\n1.  Pickups\n2.  Minivans, other light vans, and sport utility vehicles\n3.  Light single-unit trucks with gross vehicle weight less than 26,000 pounds\n4.  Heavy single-unit trucks with gross vehicle weight greater than or equal to 26,000 pounds\n5.  Truck-tractors\n\nUse the `vius.csv` textbook data to answer the following questions. The stratification variable is named `stratum` and the weights are contained in the variable `tabtrucks`.\n\na)  Estimate the total number of trucks in the US\nb)  Estimate the total number of truck miles driven in 2002 (variable `miles_annl`)\nc)  Estimate the total number of truck miles driven in 2002 for each of the five trucktypes classes.\nd)  Estimate the total number of vehicles that have gross vehicle weight exceeding 10,000 lbs (variable `vius_gvw`)\n\n:::\n\n::: {.callout-warning icon=\"false\" collapse=\"true\" appearance=\"minimal\"}\n### Solution\n:::\n",
    "supporting": [
      "cn04-stratified_sampling_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}