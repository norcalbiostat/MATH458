{
  "hash": "097288be54dbfd9c3708b2ac89d8ae09",
  "result": {
    "markdown": "---\ntitle: \"Stratified Sampling\"\ndescription: \"A method to use additional information about the population in the survey design\"\nauthor: DRAFT - Sp '25 458 class\ndate: 3/5/25\nexecute: \n  error: true\n  warning: false\n  message: false\n---\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse);library(knitr)\nlibrary(sampling); library(survey)\n# Load data\nagpop <- read_csv(here::here(\"data\", \"agpop.csv\"))\nagstrat <- read_csv(here::here(\"data\", \"agstrat.csv\"))\n```\n:::\n\n\n![Source: https://www.scribbr.com/methodology/stratified-sampling/](https://www.scribbr.com/wp-content/uploads/2020/09/stratified-sample-7-2048x863.png) \n\n# What is Stratified Sampling (Lohr 3.1)\n\n::: callout-important\n#### Key Terms\n\n**Stratified sampling** is the method by which a population is broken into $H$ subgroups(strata). Independent SRS's are taken on each subgroup. Our samples are then polled to generate overall population estimates.\n\n**Strata** are subgroups of a population that do not intersect and add up to the whole population.\n:::\n\n## Why Use A Stratified Sample?\n\n1.  **You can protect against the possibility of a really bad sample with overrepresentation of a subpopulation.** Stratified Sampling guarantees set proportions of subpopulations in your sample. Example: You can ensure 50% male and 50% female in a sample.\n2.  **Stratified sampling means you can know the precision of the data collected for subgroups of the population.** Example: comparing experiences of male and female graduates when males vastly outnumber female graduates.\n3.  **Stratified sampling can be less costly or more convenient.** You can use different sampling frames, designs, or field procedures for different strata. Example: You could use mail, email, telephone, or internet surveys based on what works best for each subpopulation\n4.  **This method has lower variance estimates for population means and totals making it more precise than an SRS.** This is demonstrated using a motivating example next. \n\n::: {.callout-tip icon=\"true\"}\n### Motivating Example - Estimating the average number of farm acres.\n\n> This needs to be written up. Why are we looking at farm acreage by region? \n\n:::\n\n:::: {.columns}\n\n::: {.column width=\"60%\"}\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\n# Mutate data to create names for levels and labels in boxplot\nagstrat.plot <- agstrat %>%\n  mutate(\n    region_factor = factor(\n      region,\n      levels = c(\"NE\", \"S\", \"NC\", \"W\"),  \n      labels = c(\"Northeast\", \"South\", \"North Central\", \"West\")\n    ),\n    acres_million = acres92/1e6 # convert acres to millions\n  )\n  \nggplot(agstrat.plot, aes(x = region_factor, y = acres_million)) +\n  stat_boxplot(geom = \"errorbar\", linetype = \"solid\", width = 0.5) +\n  geom_boxplot(outlier.shape = 1, outlier.size = 3) +\n  coord_cartesian(ylim = c(0, 2.5)) +\n  labs(\n    x = \"Region\",\n    y = \"Millions of Acres\"\n  ) +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![Figure 3.1: Distribution of farm acreage in 1992 by region](cn04-stratified_sampling_files/figure-html/unnamed-chunk-2-1.png){width=576}\n:::\n:::\n\n:::\n\n::: {.column width=\"40%\"}\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nagstrat %>% group_by(region) %>%\n  summarise(sample.average = mean(acres92), \n            sample.variance = var(acres92)) %>%\n  kable()\n```\n\n::: {.cell-output-display}\n|region | sample.average| sample.variance|\n|:------|--------------:|---------------:|\n|NC     |      300504.16|     29618183543|\n|NE     |       97629.81|      7647472708|\n|S      |      211315.04|     53587487856|\n|W      |      662295.51|    396185950266|\n:::\n:::\n\n:::\n\n::::\n\n\n> Need discussion/interpretation here\n\n::: {.callout-warning icon=\"false\"}\n### You try it.\n\nExplore the distribution of farm acreage in 1987 by region. Create a table of summary statistics and a boxplot. Discuss your findings.\n:::\n\n::: {.callout-warning icon=\"false\" collapse=\"true\" appearance=\"minimal\"}\n### Solution\n:::\n\n::: {.callout-tip icon=\"true\"}\n## Example: Using the four census regions of the United States\n\nThe data contained in `agstrat.csv` comes from a is stratified sample across four regions of the United States: Northeast, North Central, South, and West.\n\nUsing this stratified sample, estimate the total number of acres of farmland in the United States in 1992 by calculating the within strata totals, and then combining across strata. \n:::\n\nSince we took an SRS in each stratum, we estimate the population total within each stratum using \n\n$\\hat{t} = N\\bar{y}$ and $\\hat{V}(\\hat{\\tau}) = N^{2}\\hat{V}(\\bar{y})$ within each strata.\n\nFor example to estimate the total number of acres devoted to farms in the Northeast, \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n220*97629.81\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 21478558\n```\n:::\n:::\n\n\nwith estimated variance\n\n::: {.cell}\n\n```{.r .cell-code}\n220^2*(1-21/220)*(7647472708)/21\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 1.594316e+13\n```\n:::\n:::\n\n\n> need summary/conclusion of motivating example. Tie it into the next setion\n\n## Gain from stratification\n\n::: callout-important\n### Definition: Relative gain from stratification\n:::\n\n# Theory of Stratified Sampling (Lohr 3.2)\n\n## Notation and Formulas used in Stratified Random Sampling\n\n## Confidence Interval for Stratified Random Sample\n\n::: {.callout-tip icon=\"true\"}\n### Example: Estimate the total number of farm acres in 1992 (Table 3.2)\n> demonstrate using equations to recreate table 3.2. here is starter code\n\n:::\n1. Calculate summary statistics for each region.\n```\nstrata.summary.stats <- agstrat %>% \n   group_by(region) %>% \n   summarize(y.bar.h = mean(acres92),\n             s2.h    = var(acres92),\n             n.h     = n()) \n```\n2. Calculate Population region sizes, add this vector to the data frame created above.\n3. Calculate the within strata sample total \n4. Calculate the within-strata variance of this total\n5. Calculate the overall total and variance by summing these values across the strata.\n\n\n::: {.callout-warning icon=\"false\"}\n### You try it Estimate the total number of caribou... \n\n\n\n::: {.cell}\n::: {.cell-output-display}\n|Stratum | N.h| n.h| y.bar.h|   s2.h|\n|:-------|---:|---:|-------:|------:|\n|A       | 400|   8|    24.1|   5575|\n|B       |  30|  10|    25.6|   4064|\n|C       |  61|  37|   267.6| 347556|\n|D       |  18|   6|   179.0|  22798|\n|E       |  70|  39|   293.7| 123578|\n|F       | 120|  21|    33.2|   9795|\n:::\n:::\n\n:::\n\n\n\n\n::: {.callout-warning icon=\"false\"}\n### You try it\n\nThe ACLS intends to use a stratified random sample to study publications and library use among members. They divide their data into discipline, making 7 stratas.\n\nUse the summary table below to estimate the the percentage and number of respondents that are female in those seven disciplines.\n:::\n\n::: {.callout-warning icon=\"false\" collapse=\"true\" appearance=\"minimal\"}\n### Solution\n:::\n\n::: {.callout-note icon=\"false\" collapse=\"true\" appearance=\"minimal\"}\n### Clean up\n:::\n\n# Sampling Weights\n\n## How are weights calculated?\n\n## How are weights used?\n\n::: {.callout-tip icon=\"true\"}\n### Example: Re-Estimate the total number of farm acres in 1992 using sample weights\n:::\n\n::: {.callout-warning icon=\"true\"}\n### You try it Caribou weights\n:::\n\n::: {.callout-note icon=\"false\" collapse=\"true\" appearance=\"minimal\"}\n### Clean up\n:::\n\n------------------------------------------------------------------------\n\n# Allocation Methods\n\n::: callout-important\n### Method 1: Proportional Allocation\n:::\n\n::: callout-important\n### Method 2: Optimal Allocation\n:::\n\n::: callout-important\n### Method 3: Allocation for Specified Precision within Strata\n:::\n\n## Which allocation to use?\n\n# Selecting Strata\n\n### Defining Strata\n\n### How Many Strata?\n\n::: {.callout-tip icon=\"true\"}\n### Example: Estimating homeless population from NYC\n:::\n\n------------------------------------------------------------------------\n\n# Summary\n\n------------------------------------------------------------------------\n\n# Using R\n\n## Selecting a Stratified Random Sample\n\n### Using the `strata` function from the `sampling` package\n\n1.  Sort the data by the stratification variable\n\n\n::: {.cell}\n\n```{.r .cell-code}\nagpop.sorted <- agpop %>% arrange(region)\n```\n:::\n\n\n2.  Specify the desired within-strata sample sizes $n_{k}$.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nn.k <- c(103, 21, 135, 41)\n```\n:::\n\n\n3.  Create the sampling index of records to select using the `strata` function with arguments specifying the strata names, strata size, and sampling method within strata.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstrat.idx <- sampling::strata(data = agpop.sorted, stratanames = \"region\", \n                    size = n.k, method = \"srswor\")\n```\n:::\n\n\n:warning: Package conflicts can occur with the `strata` function. If it is not working for you, use the `sampling::strata` method of calling the function to ensure you are using the correct version of the `strata` function from the `sampling` package.\n\n4.  Extract the data records that correspond to the sampling index.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nag.str <- getdata(agpop.sorted, strat.idx)\nhead(ag.str)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n             county state acres92 acres87 acres82 farms92 farms87 farms82\n4  APPANOOSE COUNTY    IA  238609  244661  236501     827     891     900\n8      BOONE COUNTY    IA  330080  336666  333139     923    1029    1153\n43  HARRISON COUNTY    IA  399155  387190  408601     919    1024    1192\n54    KEOKUK COUNTY    IA  322401  343164  350693     952    1036    1193\n75  PLYMOUTH COUNTY    IA  518247  521469  518018    1615    1740    1874\n80  RINGGOLD COUNTY    IA  293266  285258  313971     676     701     776\n   largef92 largef87 largef82 smallf92 smallf87 smallf82 region ID_unit\n4        28       33       23       25       39       36     NC       4\n8        69       49       35       80       71       87     NC       8\n43       88       62       51       60       60       66     NC      43\n54       55       52       35       47       80       73     NC      54\n75       72       50       34      151      133      127     NC      75\n80       67       56       43       17       34       33     NC      80\n         Prob Stratum\n4  0.09772296       1\n8  0.09772296       1\n43 0.09772296       1\n54 0.09772296       1\n75 0.09772296       1\n80 0.09772296       1\n```\n:::\n:::\n\n\n5.  Calculate the sampling weights using the inclusion probabilities (these were created as the variable `Prob` when you used the `strata` function)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nag.str$wt <- 1/ag.str$Prob\nhead(ag.str)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n             county state acres92 acres87 acres82 farms92 farms87 farms82\n4  APPANOOSE COUNTY    IA  238609  244661  236501     827     891     900\n8      BOONE COUNTY    IA  330080  336666  333139     923    1029    1153\n43  HARRISON COUNTY    IA  399155  387190  408601     919    1024    1192\n54    KEOKUK COUNTY    IA  322401  343164  350693     952    1036    1193\n75  PLYMOUTH COUNTY    IA  518247  521469  518018    1615    1740    1874\n80  RINGGOLD COUNTY    IA  293266  285258  313971     676     701     776\n   largef92 largef87 largef82 smallf92 smallf87 smallf82 region ID_unit\n4        28       33       23       25       39       36     NC       4\n8        69       49       35       80       71       87     NC       8\n43       88       62       51       60       60       66     NC      43\n54       55       52       35       47       80       73     NC      54\n75       72       50       34      151      133      127     NC      75\n80       67       56       43       17       34       33     NC      80\n         Prob Stratum       wt\n4  0.09772296       1 10.23301\n8  0.09772296       1 10.23301\n43 0.09772296       1 10.23301\n54 0.09772296       1 10.23301\n75 0.09772296       1 10.23301\n80 0.09772296       1 10.23301\n```\n:::\n:::\n\n\n5b. Check that the sampling weights sum to the stratum population sizes.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nag.str %>% group_by(region) %>% summarize(sum.wts = sum(wt))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 4 × 2\n  region sum.wts\n  <chr>    <dbl>\n1 NC        1054\n2 NE         220\n3 S         1382\n4 W          422\n```\n:::\n\n```{.r .cell-code}\ntable(agpop.sorted$region)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n  NC   NE    S    W \n1054  220 1382  422 \n```\n:::\n:::\n\n\n::: callout-important\n### Warning\n\nIf the weights do not sum to the stratum population sizes, you have made a mistake somewhere in the calculations for the weights or strata sizes.\n:::\n\n------------------------------------------------------------------------\n\n## Computing Statistics from a Stratified Random Sample\n\n### 1. Setup the information for the survey design.\n\n#### a. Specify weights\n\nWe created the weights in the dataset in the the last step.\n\n#### b. Specify fpc\n\nWe need to create a vector of fpc's that are equal to the strata population size. In a SRS, we used `fpc = rep(N,n)`. This create a vector that contains the value `N`, repeated `n` times. In this case, we need to match the strata population size to each record from that strata.\n\nOption 1: Create a vector that repeats the values in the vector `N.k`, each `n.k` times.\n\n\n::: {.cell}\n\n```{.r .cell-code}\noption1.fpc <- rep(N.k, n.k)\n```\n:::\n\n\n::: {.callout-tip icon=\"false\" collapse=\"true\" appearance=\"minimal\"}\n**Example on how to use the `rep` function**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nex.N.k <- c(10,25,50) # example population sizes\nex.n.k <- c(2,5,10)   # example strata sizes\nrep(ex.N.k, ex.n.k)   \n```\n\n::: {.cell-output .cell-output-stdout}\n```\n [1] 10 10 25 25 25 25 25 50 50 50 50 50 50 50 50 50 50\n```\n:::\n:::\n\n\nThe pop size for stratum 1 is repeated twice (the size of the sample from that stratum), the pop size for stratum 2 is repeated 5 times (the sample size for stat stratum) etc.\n:::\n\nOption 2: Merge the pop sizes onto the sample data using `region` as a joining key\n\n\n::: {.cell}\n\n```{.r .cell-code}\n(pop.strata.sizes <- table(agpop.sorted$region) %>% data.frame())\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n  Var1 Freq\n1   NC 1054\n2   NE  220\n3    S 1382\n4    W  422\n```\n:::\n\n```{.r .cell-code}\npop.strata.sizes <- rename(pop.strata.sizes, region = Var1, popsize = Freq)\nag.str.opt2 <- ag.str %>% left_join(pop.strata.sizes)\n```\n:::\n\n\n### 2. Call `svydesign`\n\n\n::: {.cell}\n\n```{.r .cell-code}\nagpop.str.dsgn <- svydesign(id = ~1, strata = ~region, weights = ~wt, \n                            fpc = ~popsize, \n                            # fpc = option1.fpc # This would be Option 1\n                            data= ag.str.opt2)\n```\n:::\n\n\n### 3. Calculate total, SE and CI\n\nNote the degrees of freedom for a CI under a stratified sample is $n-H$, which can be extracted from the `svydesign` object using the `degf` function.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n(str.total <- svytotal(~acres92, agpop.str.dsgn))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n             total       SE\nacres92 1057743345 65105302\n```\n:::\n\n```{.r .cell-code}\nconfint(str.total, level = .95, df = degf(agpop.str.dsgn))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n            2.5 %     97.5 %\nacres92 929615413 1185871277\n```\n:::\n:::\n\n\n::: {.callout-tip icon=\"true\"}\n### Example: Farmland in 1992\n:::\n\n::: {.callout-warning icon=\"false\"}\n### Estimating vehicle information for the entire USA.\n:::\n\n::: {.callout-warning icon=\"false\" collapse=\"true\" appearance=\"minimal\"}\n### Solution\n:::\n",
    "supporting": [
      "cn04-stratified_sampling_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}