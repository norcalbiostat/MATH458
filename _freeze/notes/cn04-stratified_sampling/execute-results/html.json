{
  "hash": "066fce0a69facc90f81bdbf6c42c0bfa",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Stratified Sampling\"\ndescription: \"A method to use additional information about the population in the survey design\"\nauthor: DRAFT - Sp '25 458 class\ndate: 3/5/25\nexecute: \n  error: true\n  warning: false\n  message: false\n---\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse);library(knitr)\nlibrary(sampling); library(survey)\n# Load data\nagpop <- read_csv(here::here(\"data\", \"agpop.csv\"))\nagstrat <- read_csv(here::here(\"data\", \"agstrat.csv\"))\n```\n:::\n\n\n![Source: https://www.scribbr.com/methodology/stratified-sampling/](https://www.scribbr.com/wp-content/uploads/2020/09/stratified-sample-7-2048x863.png)\n\n# What is Stratified Sampling (Lohr 3.1)\n\n::: callout-important\n#### Key Terms\n\n**Stratified sampling** is the method by which a population is broken into $H$ subgroups(strata). Independent SRS's are taken on each subgroup. Our samples are then polled to generate overall population estimates.\n\n**Strata** are subgroups of a population that do not intersect and add up to the whole population.\n:::\n\n## Why Use A Stratified Sample?\n\n1.  **You can protect against the possibility of a really bad sample with overrepresentation of a subpopulation.** Stratified Sampling guarantees set proportions of subpopulations in your sample. Example: You can ensure 50% male and 50% female in a sample.\n2.  **Stratified sampling means you can know the precision of the data collected for subgroups of the population.** Example: comparing experiences of male and female graduates when males vastly outnumber female graduates.\n3.  **Stratified sampling can be less costly or more convenient.** You can use different sampling frames, designs, or field procedures for different strata. Example: You could use mail, email, telephone, or internet surveys based on what works best for each subpopulation\n4.  **This method has lower variance estimates for population means and totals making it more precise than an SRS.** This is demonstrated using a motivating example next.\n\n::: {.callout-tip icon=\"true\"}\n### Motivating Example - Estimating farm details.\n\nDuring the colonial period of the United States travel was limited and most of the population lived on the East coast. The states are small in size, the population denser, and thus the farmland is smaller. In the 1800's the US \"acquired\" the western half of the US in large patches. This led to much larger farmland, owned by fewer individuals.\n\nThe distribution of farm acreage in 1992 for each region is summarized below.\n:::\n\n::: columns\n::: {.column width=\"60%\"}\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\n# Mutate data to create names for levels and labels in boxplot\nagstrat.plot <- agstrat %>%\n  mutate(\n    region_factor = factor(\n      region,\n      levels = c(\"NE\", \"S\", \"NC\", \"W\"),  \n      labels = c(\"Northeast\", \"South\", \"North Central\", \"West\")\n    ),\n    acres_million = acres92/1e6 # convert acres to millions\n  )\n  \nggplot(agstrat.plot, aes(x = region_factor, y = acres_million)) +\n  stat_boxplot(geom = \"errorbar\", linetype = \"solid\", width = 0.5) +\n  geom_boxplot(outlier.shape = 1, outlier.size = 3) +\n  coord_cartesian(ylim = c(0, 2.5)) +\n  labs(\n    x = \"Region\",\n    y = \"Millions of Acres\"\n  ) +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![Figure 3.1: Distribution of farm acreage in 1992 by region](cn04-stratified_sampling_files/figure-html/unnamed-chunk-2-1.png){width=576}\n:::\n:::\n\n:::\n\n::: {.column width=\"40%\"}\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nagstrat %>% group_by(region) %>%\n  summarise(sample.average = mean(acres92), \n            sample.variance = var(acres92)) %>%\n  kable()\n```\n\n::: {.cell-output-display}\n\n\n|region | sample.average| sample.variance|\n|:------|--------------:|---------------:|\n|NC     |      300504.16|     29618183543|\n|NE     |       97629.81|      7647472708|\n|S      |      211315.04|     53587487856|\n|W      |      662295.51|    396185950266|\n\n\n:::\n:::\n\n:::\n:::\n\nEach region has its own box plot we can compare. Each with a marked median (the thick solid line), the 25th and 75th percentiles marked by the edges of the box and its outliers. Each of the regions (except the West) tend to have quite a few high-end outliers (aka positively skewed). The NE region has the smallest average farm size (9.7k acres) and the smallest variance (7.6B) whereas the west has quite a large variance (396B) and mean(622k)\n\nTo properly estimate the average size of a farm, or the total number of farms, we want to ensure our sample is representative of the population. A SRS may end up oversampling small farms from the east and missing out on larger farms from the west. This is why we considered stratification for this example.\n\n::: {.callout-warning icon=\"false\"}\n### You try it.\n\nExplore the distribution of farm acreage in 1982 by region. Create a table of summary statistics and a boxplot. Discuss your findings.\n:::\n\n::: {.callout-warning icon=\"false\" collapse=\"true\" appearance=\"minimal\"}\n### Solution\n:::\n\n::: {.callout-tip icon=\"true\"}\n## Example: Estimating the total acerage of farmland.\n\nThe data contained in `agstrat.csv` comes from a is stratified sample across four regions of the United States: Northeast, North Central, South, and West.\n\nUsing this stratified sample, estimate the total number of acres of farmland in the United States in 1992 by calculating the within strata totals, and then combining across strata.\n:::\n\nSince we took an SRS in each stratum, we estimate the population total within each stratum using $\\hat{t} = N\\bar{y}$ and $\\hat{V}(\\hat{\\tau}) = N^{2}\\hat{V}(\\bar{y})=N^{2}(1 - \\frac{n}{N})\\frac{s^{2}}{n}$ within each strata.\n\nFor example to estimate the total number of acres devoted to farms in the Northeast,\n\n\n::: {.cell}\n\n```{.r .cell-code}\n220*97629.81\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 21478558\n```\n\n\n:::\n:::\n\n\nwith estimated variance\n\n\n::: {.cell}\n\n```{.r .cell-code}\n220^2*(1-21/220)*(7647472708)/21\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 1.594316e+13\n```\n\n\n:::\n:::\n\n\nLohr table 3.2 gives *estimates* of the total number of farm acres, $\\hat{t}_{h}$, and estimated variance of the total, $\\hat{V}(\\hat{t}_{h})$, for each of the $h=4$ strata. Knowing this is an important key detail that shows us that the overall variance of the estimate is reduced by having the regions broken up into strata. This table also shows that if used efficiently, less samples are needed with stratified sampling to achieve the same, it not better, precision. In regards to the farm acres, this table highlights the variability in sizes of farms and area used for farm land in each stratum.\n\n## Gain from stratification\n\nObservations within strata are more similar to each other, than they are to the population as a whole. A reduction in variance in individual strata can lead to a reduced variance for the population estimate.\n\n::: callout-important\n### Definition: Relative gain from stratification\n\nThe reduction in variance from using a stratified sample compared to a SRS.\n:::\n\nThis is estimated by the ratio:\n\n$$\n\\frac{\\mbox{estimated variance from stratified sample}}{\\mbox{estimated variance from SRS}}\n$$\n\nUsing the farm example,\n\n$$\\frac{2.5419 * 10^{15}}{3.3837 * 10^{15}} =0.75 $$\n\nThe variance is reduced by 75% from the method of stratified sampling method compared to the SRS method.\n\n# Theory of Stratified Sampling (Lohr 3.2)\n\nThe formulas presented in this section are summarized in a table on the [formulas page](https://sampling-458.netlify.app/formulas#stratified-random-sample).\n\n## Notation\n\n-   $n$ - total sample size, from all strata\n-   $N$ - total population size, from all strata\n-   $y_{hj}$ - value of the $j^{th}$ unit in stratum $h$\n-   $H$ - total number of strata\n\n| Measure on stratum $h$  | Population | Statistic   |\n|-------------------------|------------|-------------|\n| number of units         | $N_{H}$    | $n_h$       |\n| total (sum of $y_{hj}$) | $t_h$      | $\\hat{t}_h$ |\n| mean of $y_{hj}$        | $\\mu_{h}$  | $\\bar{y}_h$ |\n| variance of $y_{hj}$    | $S^2_h$    | $s^2_h$     |\n| proportion of event     | $p_h$      | $\\hat{p}_h$ |\n\n## Estimators for Population Parameters\n\nThe estimators for the population parameters are the sum (or weighted sum) of the strata level estimators. Since an SRS was taken within each strata, $\\hat{\\tau}_{str}$ and $\\bar{y}_{str}$ are unbiased estimators of $\\tau$ and $\\mu$ respectively.\n\n-   $\\hat{\\tau}_{str} = \\sum_{h}\\hat{\\tau}_{h}$ - the estimate for $t$, the total for the entire population\n-   $\\bar{y}_{str} = \\sum_{h} \\frac{N_{h}}{N}\\bar{y}_{h}$ - the estimate for $\\mu$, the overall population mean. This is the weighted average of the sample stratum means.\n-   $\\hat{p}_{str} = \\sum_{h}\\frac{N_{h}}{N}\\hat{p}_{h}$ - the estimated overall population proportion $p$\n\n## Variance of overall estimators\n\nSince the SRS's within each strata are taken independently, the variances within each strata are mutually independent. Thus the estimated variance for the populations estimates are calculated by summing up (over the $H$ layers), the individual strata variances.\n\n-   $\\hat{V}(\\hat{\\tau}_{str}) = \\sum_{h} \\hat{V}(\\hat{\\tau}_{h})$ - the estimate for the variance of the estimate of the population total found by substituting the sample variances for the population variances.\n-   $\\hat{V}(\\bar{y}_{str}) = \\frac{1}{N^2}\\hat{V}(\\hat{\\tau}_{str})$ - the estimate for the variance of the estimate of the population mean found by substituting the sample variances for the population variances.\n-   $\\hat{V}(\\hat{p}_{str}) = \\sum_{h} (1-\\frac{n_h}{N_h})\\big(\\frac{N_{h}}{N}\\big)^2\\Big(\\frac{\\hat{p}_h(1-\\hat{p}_h)}{n_h-1}\\Big)$ - the estimated variance of the estimated overall population proportion\n\nThe *standard errors* for these estimators are the square roots of their estimated variances. By substituting our sample variances for population variances, that is $s_h$ for $S_h$, we can obtain unbiased estimators of the variances.\n\n## Confidence Intervals\n\n**Confidence intervals for stratified samples** Conditions for formula to be valid: either (1) the sample sizes within EACH stratum are large, or (2) there is a large number of strata\n\n100(1- $\\alpha$)% confidence interval is given by: $$\\bar{y}_{str} \\pm z_{\\alpha/2} * SE(\\bar{y}_{str})$$ However, most survey packages use a $t_{n-H}$ distribution instead of using the normal assumption.\n\n## Strata level estimates\n\n| Measure on stratum $h$ | Estimate                                       | Variance                                                                 |\n|------------------------|-------------------|---------------------------|\n| total                  | $\\hat{\\tau}_{h} = N_{h}\\bar{y_h}$              | $\\hat{V}(\\hat{\\tau}_{h}) = (1-\\frac{n_h}{N_h})N_{h}^2 \\frac{s^2_h}{n_h}$ |\n| mean                   | $\\bar{y}_{h} = \\frac{1}{n_{h}}\\sum_{j} y_{hj}$ | $\\hat{V}(\\bar{y}_{h}) = \\frac{1}{N^2}V(\\hat{\\tau}_{h})$                  |\n| proportion             | $\\hat{p}_{h} = \\bar{y}_{h}$                    | $\\hat{V}(\\hat{p}_{h}) = (\\frac{n_h}{n_h-1})\\hat{p}_h(1-\\hat{p}_h)$       |\n\n::: {.callout-tip icon=\"true\"}\n### Example: Estimate the total number of farm acres in 1992 (Table 3.2)\n\nEstimate the total number of acres of farmland in the United States in 1992 by calculating the within strata totals, and then combining across strata.\n:::\n\n1.  Calculate summary statistics for each region.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstrata.summary.stats <- agstrat %>% \n   group_by(region) %>% \n   summarize(y.bar.h = mean(acres92),\n             s2.h    = var(acres92),\n             n.h     = n()) \nstrata.summary.stats\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 4 × 4\n  region y.bar.h          s2.h   n.h\n  <chr>    <dbl>         <dbl> <int>\n1 NC     300504.  29618183543.   103\n2 NE      97630.   7647472708.    21\n3 S      211315.  53587487856.   135\n4 W      662296. 396185950266.    41\n```\n\n\n:::\n:::\n\n\n2.  Calculate Population region sizes, add this vector to the data frame created above.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntable(agpop$region) ## number of farms by region \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n  NC   NE    S    W \n1054  220 1382  422 \n```\n\n\n:::\n\n```{.r .cell-code}\nstrata.summary.stats$N.h = c(1054,220,1382,422) \nstrata.summary.stats ##added as column \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 4 × 5\n  region y.bar.h          s2.h   n.h   N.h\n  <chr>    <dbl>         <dbl> <int> <dbl>\n1 NC     300504.  29618183543.   103  1054\n2 NE      97630.   7647472708.    21   220\n3 S      211315.  53587487856.   135  1382\n4 W      662296. 396185950266.    41   422\n```\n\n\n:::\n:::\n\n\n3.  Calculate the within strata sample total: $\\hat{\\tau}_{h} = N_{h}\\bar{y_h}$\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstrata.summary.stats$t.h <- strata.summary.stats$y.bar.h*strata.summary.stats$N.h \n\nstrata.summary.stats\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 4 × 6\n  region y.bar.h          s2.h   n.h   N.h        t.h\n  <chr>    <dbl>         <dbl> <int> <dbl>      <dbl>\n1 NC     300504.  29618183543.   103  1054 316731380.\n2 NE      97630.   7647472708.    21   220  21478558.\n3 S      211315.  53587487856.   135  1382 292037391.\n4 W      662296. 396185950266.    41   422 279488706.\n```\n\n\n:::\n:::\n\n\n4.  Calculate the within-strata variance of this total $$\\sum_{h=1}^{H} V(\\hat{t}_h) = \\sum_{h=1}^{H} \\left( 1 - \\frac{n_h}{N_h} \\right)N_{h}^2 \\frac{S_h^2}{n_h}$$\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstrata.summary.stats$V.t <- ((1 - (strata.summary.stats$n.h/strata.summary.stats$N.h))*(strata.summary.stats$N.h^2)*\n(strata.summary.stats$s2.h)/strata.summary.stats$n.h)\n\nstrata.summary.stats\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 4 × 7\n  region y.bar.h          s2.h   n.h   N.h        t.h     V.t\n  <chr>    <dbl>         <dbl> <int> <dbl>      <dbl>   <dbl>\n1 NC     300504.  29618183543.   103  1054 316731380. 2.88e14\n2 NE      97630.   7647472708.    21   220  21478558. 1.59e13\n3 S      211315.  53587487856.   135  1382 292037391. 6.84e14\n4 W      662296. 396185950266.    41   422 279488706. 1.55e15\n```\n\n\n:::\n:::\n\n\n5.  Calculate the overall total and variance by summing these values across the strata.\n\n$$\\hat{\\tau}_{str} = \\sum_{h}\\hat{\\tau}_{h}, \\qquad \\mbox{ and } \\qquad \\hat{V}(\\hat{t}_{str}) = \\sum_{h=1}^{H} V(\\hat{t}_h)$$\n\n\n::: {.cell}\n\n```{.r .cell-code}\n(total.sum <- sum(strata.summary.stats$t.h)) \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 909736035\n```\n\n\n:::\n\n```{.r .cell-code}\n(total.var <- sum(strata.summary.stats$V.t))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 2.541899e+15\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n:::\n\n\n::: {.callout-warning icon=\"false\"}\n### You try it\n\nEstimate the total number of caribou...\n\n\n::: {.cell}\n::: {.cell-output-display}\n\n\n|Stratum | N.h| n.h| y.bar.h|   s2.h|\n|:-------|---:|---:|-------:|------:|\n|A       | 400|   8|    24.1|   5575|\n|B       |  30|  10|    25.6|   4064|\n|C       |  61|  37|   267.6| 347556|\n|D       |  18|   6|   179.0|  22798|\n|E       |  70|  39|   293.7| 123578|\n|F       | 120|  21|    33.2|   9795|\n\n\n:::\n:::\n\n:::\n\n::: {.callout-note icon=\"false\" collapse=\"true\" appearance=\"minimal\"}\n### Clean up\n:::\n\n# Sampling Weights\n\n## How are weights calculated?\n\n* The sampling weight for an observation is the reciprocal of its probability of inclusion.\n* The probability of inclusion for a unit in a stratum is calculated as the sample size divided by the total number of units in that stratum.\n\n$$w_{hj}=\\frac{N_h}{n_h}$$\n\nThe sum of the weights will equal the population size. \n\n$\\sum_h\\sum_jw_{hj}=N$\n\n## How are weights used?\n\nThe stratified sampling estimator of the total population is expressed as the sum of weighted observations across all strata.\n\n$$\\hat{t}_{str}=\\sum_h\\sum_jw_{hj}y_{hj}$$\n\n* apply weights to observations\n* inner sum is within strata\n* outer sum is across strata\n\nThe population mean-average of the observations weighted by strata.\n\n$$\\bar{y}_{str}=\\frac{\\sum_h\\sum_jw_{hj}y_{hj}}{\\sum_h\\sum_jw_{hj}}$$\n\n\n::: {.callout-tip icon=\"true\"}\n### Example: Re-Estimate the total number of farm acres in 1992 using sample weights\n:::\n\n::: {.callout-warning icon=\"true\"}\n### You try it Caribou weights\n:::\n\n------------------------------------------------------------------------\n\n# Allocation Methods\n\n::: callout-important\n### Method 1: Proportional Allocation\n:::\n\n::: callout-important\n### Method 2: Optimal Allocation\n:::\n\n::: callout-important\n### Method 3: Allocation for Specified Precision within Strata\n:::\n\n## Which allocation to use?\n\n# Selecting Strata\n\n### Defining Strata\n\n### How Many Strata?\n\n::: {.callout-tip icon=\"true\"}\n### Example: Estimating homeless population from NYC\n:::\n\n------------------------------------------------------------------------\n\n# Summary\n\n------------------------------------------------------------------------\n\n# Using R\n\n## Selecting a Stratified Random Sample\n\n### Using the `strata` function from the `sampling` package\n\n1.  Sort the data by the stratification variable\n\n\n::: {.cell}\n\n```{.r .cell-code}\nagpop.sorted <- agpop %>% arrange(region)\n```\n:::\n\n\n2.  Specify the desired within-strata sample sizes $n_{k}$.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nn.k <- c(103, 21, 135, 41)\n```\n:::\n\n\n3.  Create the sampling index of records to select using the `strata` function with arguments specifying the strata names, strata size, and sampling method within strata.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstrat.idx <- sampling::strata(data = agpop.sorted, stratanames = \"region\", \n                    size = n.k, method = \"srswor\")\n```\n:::\n\n\n:warning: Package conflicts can occur with the `strata` function. If it is not working for you, use the `sampling::strata` method of calling the function to ensure you are using the correct version of the `strata` function from the `sampling` package.\n\n4.  Extract the data records that correspond to the sampling index.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nag.str <- getdata(agpop.sorted, strat.idx)\nhead(ag.str)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n            county state acres92 acres87 acres82 farms92 farms87 farms82\n41  HANCOCK COUNTY    IA  329151  347774  351156     939    1052    1176\n43 HARRISON COUNTY    IA  399155  387190  408601     919    1024    1192\n46 HUMBOLDT COUNTY    IA  280797  275393  275422     677     754     848\n48     IOWA COUNTY    IA  321285  329705  361465     977    1057    1150\n59    LUCAS COUNTY    IA  219370  206519  219497     630     690     769\n66 MITCHELL COUNTY    IA  263047  270582  273000     825     939    1011\n   largef92 largef87 largef82 smallf92 smallf87 smallf82 region ID_unit\n41       44       26       25       67       64       70     NC      41\n43       88       62       51       60       60       66     NC      43\n46       44       28       24       50       46       51     NC      46\n48       43       32       36       58       64       62     NC      48\n59       35       31       28       16       30       34     NC      59\n66       36       25       19       79       97       72     NC      66\n         Prob Stratum\n41 0.09772296       1\n43 0.09772296       1\n46 0.09772296       1\n48 0.09772296       1\n59 0.09772296       1\n66 0.09772296       1\n```\n\n\n:::\n:::\n\n\n5.  Calculate the sampling weights using the inclusion probabilities (these were created as the variable `Prob` when you used the `strata` function)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nag.str$wt <- 1/ag.str$Prob\nhead(ag.str)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n            county state acres92 acres87 acres82 farms92 farms87 farms82\n41  HANCOCK COUNTY    IA  329151  347774  351156     939    1052    1176\n43 HARRISON COUNTY    IA  399155  387190  408601     919    1024    1192\n46 HUMBOLDT COUNTY    IA  280797  275393  275422     677     754     848\n48     IOWA COUNTY    IA  321285  329705  361465     977    1057    1150\n59    LUCAS COUNTY    IA  219370  206519  219497     630     690     769\n66 MITCHELL COUNTY    IA  263047  270582  273000     825     939    1011\n   largef92 largef87 largef82 smallf92 smallf87 smallf82 region ID_unit\n41       44       26       25       67       64       70     NC      41\n43       88       62       51       60       60       66     NC      43\n46       44       28       24       50       46       51     NC      46\n48       43       32       36       58       64       62     NC      48\n59       35       31       28       16       30       34     NC      59\n66       36       25       19       79       97       72     NC      66\n         Prob Stratum       wt\n41 0.09772296       1 10.23301\n43 0.09772296       1 10.23301\n46 0.09772296       1 10.23301\n48 0.09772296       1 10.23301\n59 0.09772296       1 10.23301\n66 0.09772296       1 10.23301\n```\n\n\n:::\n:::\n\n\n5b. Check that the sampling weights sum to the stratum population sizes.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nag.str %>% group_by(region) %>% summarize(sum.wts = sum(wt))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 4 × 2\n  region sum.wts\n  <chr>    <dbl>\n1 NC       1054.\n2 NE        220 \n3 S        1382.\n4 W         422 \n```\n\n\n:::\n\n```{.r .cell-code}\ntable(agpop.sorted$region)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n  NC   NE    S    W \n1054  220 1382  422 \n```\n\n\n:::\n:::\n\n\n::: callout-important\n### Warning\n\nIf the weights do not sum to the stratum population sizes, you have made a mistake somewhere in the calculations for the weights or strata sizes.\n:::\n\n------------------------------------------------------------------------\n\n## Computing Statistics from a Stratified Random Sample\n\n### 1. Setup the information for the survey design.\n\n#### a. Specify weights\n\nWe created the weights in the dataset in the the last step.\n\n#### b. Specify fpc\n\nWe need to create a vector of fpc's that are equal to the strata population size. In a SRS, we used `fpc = rep(N,n)`. This create a vector that contains the value `N`, repeated `n` times. In this case, we need to match the strata population size to each record from that strata.\n\nOption 1: Create a vector that repeats the values in the vector `N.k`, each `n.k` times.\n\n\n::: {.cell}\n\n```{.r .cell-code}\noption1.fpc <- rep(N.k, n.k)\n```\n:::\n\n\n::: {.callout-tip icon=\"false\" collapse=\"true\" appearance=\"minimal\"}\n**Example on how to use the `rep` function**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nex.N.k <- c(10,25,50) # example population sizes\nex.n.k <- c(2,5,10)   # example strata sizes\nrep(ex.N.k, ex.n.k)   \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n [1] 10 10 25 25 25 25 25 50 50 50 50 50 50 50 50 50 50\n```\n\n\n:::\n:::\n\n\nThe pop size for stratum 1 is repeated twice (the size of the sample from that stratum), the pop size for stratum 2 is repeated 5 times (the sample size for stat stratum) etc.\n:::\n\nOption 2: Merge the pop sizes onto the sample data using `region` as a joining key\n\n\n::: {.cell}\n\n```{.r .cell-code}\n(pop.strata.sizes <- table(agpop.sorted$region) %>% data.frame())\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  Var1 Freq\n1   NC 1054\n2   NE  220\n3    S 1382\n4    W  422\n```\n\n\n:::\n\n```{.r .cell-code}\npop.strata.sizes <- rename(pop.strata.sizes, region = Var1, popsize = Freq)\nag.str.opt2 <- ag.str %>% left_join(pop.strata.sizes)\n```\n:::\n\n\n### 2. Call `svydesign`\n\n\n::: {.cell}\n\n```{.r .cell-code}\nagpop.str.dsgn <- svydesign(id = ~1, strata = ~region, weights = ~wt, \n                            fpc = ~popsize, \n                            # fpc = option1.fpc # This would be Option 1\n                            data= ag.str.opt2)\n```\n:::\n\n\n### 3. Calculate total, SE and CI\n\nNote the degrees of freedom for a CI under a stratified sample is $n-H$, which can be extracted from the `svydesign` object using the `degf` function.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n(str.total <- svytotal(~acres92, agpop.str.dsgn))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n            total       SE\nacres92 894151478 53251536\n```\n\n\n:::\n\n```{.r .cell-code}\nconfint(str.total, level = .95, df = degf(agpop.str.dsgn))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n            2.5 %    97.5 %\nacres92 789351883 998951072\n```\n\n\n:::\n:::\n\n\n::: {.callout-tip icon=\"true\"}\n### Example: Farmland in 1992\n:::\n\n::: {.callout-warning icon=\"false\"}\n### Estimating vehicle information for the entire USA.\n:::\n\n::: {.callout-warning icon=\"false\" collapse=\"true\" appearance=\"minimal\"}\n### Solution\n:::\n",
    "supporting": [
      "cn04-stratified_sampling_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}