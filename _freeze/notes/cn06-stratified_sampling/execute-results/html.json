{
  "hash": "2196387d29b93662ff116f54becc89a1",
  "result": {
    "markdown": "---\ntitle: \"Stratified Sampling\"\ndescription: \"A method to use additional information about the population in the survey design. Lohr Ch 3. \"\nauthor: DRAFT - 458 class\ndate: 3/20/23\nexecute: \n  error: true\n  warning: false\n  message: false\n---\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(here); library(tidyverse);library(knitr)\nlibrary(sampling); library(survey)\n```\n:::\n\n\n# What is Stratified Sampling \n\n\n## Overview\n\n* A sampling technique in which we divide the desired population into subgroups called _strata_\n* Each individual is necessarily in a single strata; no overlap within strata\n* All strata consist of the entire population\n* An SRS is taken from each strata, then results can be pooled to make inferences about the entire population\n\n### Why Use A Stratified Sample?\n\n* Protection from bad samples; less likely of drawing a non representative sample through pure chance\n* Want data of known subgroups (i.e.,  if we are interested in people’s heights, we know that men tend to be taller than women)\n* Convenience / cost effectiveness \n– At what point will this compromise the legitimacy of the study? \n* Lowers variance when done properly; variance within each strata is likely lower than the population variance\n* you do not have to sample the same fraction of observations in each stratum. If the variability is higher in a certain strata then you can try to reduce the variability of the estimated total by taking more observations from that stratum. \n:::{.callout-tip icon=true}\n\n### Motivating Example - Estimating the average number of farm acres.  \n\n\n::: {.cell}\n\n```{.r .cell-code}\nagpop <- read_csv(here(\"data\", \"agpop.csv\"))\n```\n:::\n\n\nIn Example 2.6  we took a SRS to find the average number of farm acres per county. Even though our methods of taking an SRS were correct, some areas of the country were over or underrepresented due to the variability in the size of farms in different regions in the country. An example of this would be that western states in the U.S tend to be larger, and therefore tend to have larger farms. \n\nTo try and fix this, we can use a stratified sample can give balance to the sample on the stratifying variable, which in this case would be region that the farms are located. \n:::\n\nTo begin, we can divide our data into four regions (these are the strata): \n\n\n::: {.cell}\n\n```{.r .cell-code}\nunique(agpop$region) # the four regions and their names\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"W\"  \"S\"  \"NE\" \"NC\"\n```\n:::\n:::\n\n\nPreviously we sampled 10% of the population with an SRS, and so to be able to compare our results with our stratified sample, we should sample 10% of the population from each strata through four separate and independent SRS's. \n\nThe process to do this would be to take the four regions, number off the counties that are in the region, calculate what number of counties is 10% of the total number of counties in the region, and select that many numbers from the list of numbered counties. \n\n> _Details on how to do this in R is covered in a later section. For now we will use the `agstrat` dataset from the book as the stratified sample._ \n\n\n::: {.cell}\n\n```{.r .cell-code}\nagstrat <- read_csv(here(\"data\", \"agstrat.csv\"))\n```\n:::\n\n\n\n:::{.callout-tip icon=true}\n### Exploring the distribution of farm acreage in 1992 by region.\n\n\n::: {.cell .fig-cap-location-top}\n\n```{.r .cell-code}\nboxplot(acres92/10^6 ~ region, data = agstrat,\n        xlab = \"Region\", ylab = \"Millions of Acres\")\n```\n\n::: {.cell-output-display}\n![The thick line for each region is the median of the sample data from that region. The upper and lower horizontal lines of the boxes are the 25th and 75th percentiles.](cn06-stratified_sampling_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\nThe Northeast has the lowest median and the smallest variance. The West has the highest median and the highest mean and variance. The distribution of farm acreage appears to to be positively skewed in each region.\n\n:::\n\nThe summary statistics $\\bar{y}_{h}$ and $s^{2}_{h}$ can be calculated using R after grouping by the stratification variable. \n\n\n::: {.cell}\n\n```{.r .cell-code}\ntable3.1 <- agstrat %>% \n   group_by(region) %>% \n   summarize(y.bar.h = mean(acres92),\n             s2.h    = var(acres92),\n             n.h     = n())\n\ncounties_in_pop <- table(agpop$region)\nnew_table3.1 <- cbind(table3.1, counties_in_pop)\nnew_table3.1 <- select(new_table3.1, -Var1) # drop the extra variable \ncolnames(new_table3.1) <- c(\"Region\", \"Sample Avg in Region\", \"Sample Variance in Region\", \n\"Number of Counties in Region\", \"Number of Counties in Population\")\n\nkable(new_table3.1)\n```\n\n::: {.cell-output-display}\n|Region | Sample Avg in Region| Sample Variance in Region| Number of Counties in Region| Number of Counties in Population|\n|:------|--------------------:|-------------------------:|----------------------------:|--------------------------------:|\n|NC     |            300504.16|               29618183543|                          103|                             1054|\n|NE     |             97629.81|                7647472708|                           21|                              220|\n|S      |            211315.04|               53587487856|                          135|                             1382|\n|W      |            662295.51|              396185950266|                           41|                              422|\n\n\n\nLohr Table 3.1. Summary statistics for each stratum\n:::\n:::\n\n\nThese summary statistics can be used to calculate estimates of the total number of farms acres, and estimated variance of the total within each of the four stratum (Table 3.2 below)\n\nBecause we took an SRS in each stratum, we can use the following equations to estimate population quantities for each stratum. \n\n$\\hat{\\tau_{h}} = N * \\bar{y}_{h} \\quad \\mbox{ and } \\quad \\hat{V}(\\hat{\\tau}_{h}) = N_{h}^{2} * \\hat{V}(\\bar{y}_{h})$\n\n* We can estimate the total number of acres devoted to farming in the United States in 1992 by summing the estimated totals for each stratum.\n* The variance of the total is the sum of the variances of the estimated stratum totals.\n\n> More information on how to do this in the next section. \n\n\n:::{.callout-warning icon=false}\n### :star: You try it. \nExplore the distribution of farm acreage in 1987 by region. Create a table of summary statistics and a boxplot. Discuss your findings. \n:::\n\n:::{.callout-warning icon=false collapse=\"true\" appearance=minimal}\n### Solution\n\n::: {.cell}\n\n```{.r .cell-code}\nagstrat %>%\n  group_by(region) %>%\n  summarize(y.bar = mean(farms87),\n            s2 = var(farms87),\n            n. =n())\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 4 × 4\n  region y.bar      s2    n.\n  <chr>  <dbl>   <dbl> <int>\n1 NC      837. 156050.   103\n2 NE      605. 175660.    21\n3 S       610. 231169.   135\n4 W       615. 275507.    41\n```\n:::\n\n```{.r .cell-code}\nggplot(agstrat, aes(x = region, y = farms87, fill = region)) +\n  geom_boxplot() +\n  labs(title = \"Box Plot of Farm acreage in 1987 by Region\",\n       x = \"Region\",\n       y = \"Acreage\")\n```\n\n::: {.cell-output-display}\n![](cn06-stratified_sampling_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n:::\n\n:::{.callout-important}\n### MISSING INFO\nThis group needs to add text information here. Interpret your numbers and plots in context of the purpose of the motivating example. \n:::\n\n\n## Gain from stratification\n\n-   Observations within strata are more similar to each other, than they are to the population as a whole\n-   reduction in variance in individual strata can lead to a reduced variance for the population estimate.\n\n::: callout-important\n### Definition: Relative gain from stratification\n\n$$\n\\frac{\\hat{Var_{strata}}}{\\hat{Var_{SRS}}}\n$$\n:::\n\nFrom the Farm example, this ratio was calculated to be 0.75. That means we would only need 0.75\\*300 = 225 observations from a stratified sample to obtain the same precision as from a SRS of 300.\n\n> By sampling within strata, we are \"borrowing\" information from other similar observations.\n\n\n## Summary\n\n* This section setup the motivation for why using the stratified sampling method may be beneficial. \n* Once SRS's are taken from each strata, the results can be pooled to make inferences about the entire population (the ultimate goal). \n* Don't have to sample the same % from each strata\n* Could see a greater reduction in variance with an increased sampling fraction from the West.\n\n\n# Theory of Stratified Sampling \n\n## Notation and Formulas used in Stratified Random Sampling \n\n* To take a stratified random sample, we take a SRS from each stratum, so that $n_h$ units are sampled from the $N_h$ population units in stratum $h$. \n* Statistics and sample sizes for stratum $h$ have subscript $h$ where $h=1 \\ldots H$ index strata\n* When a statistic has the subscript $str$, that means that the statistic is the combined estimate across all stratas. \n    - $\\bar{y}_{str}$ is a weighted average of the sample stratum means\n    - $\\hat{p}_{str}$ estimated proportion of population units having a specified characteristic. _Recall a proportion is a mean of a variable that takes on the values 0 and 1._\n* $y_{hj}$ value of the $j$th unit in strata $h$\n* $\\sum_{j=1}^{n_{h}}$ means to sum of *all* units in strata $h$\n* $\\sum_{j}$ means to sum over the units that were sampled from in strata $h$\n* $\\sum_{h}$ is shorthand for $\\sum_{H=1}^{h}$\n\n\n\n::: {.panel-tabset}\n## Formulas\n\n\n| Measure                   | Population $(\\theta)$                                                  | Sample $(\\hat{\\theta})$                                     |\n|------------------|-----------------------------|-----------------------------|\n| Sample size in strata $h$ | $N_{h}$                                                                | $n_{h}$                                                     |\n| Overall sample size       | $N = \\sum_{h} N_{h}$                                             | $n = \\sum_{h} n_{h}$                                  |\n| Total in strata $h$       | $\\tau_{h} = \\sum_{j=1}^{N_{h}} y_{hj}$                                 | $\\hat{\\tau}_{h} = N_{h}\\bar{y_h}$                           |\n| Overall total             | $\\tau = \\sum_{h} \\tau_{h}$                                       | $\\hat{\\tau}_{str} = \\sum_{h}N_{h}\\bar{y}_{h}$         |\n| Mean in strata $h$        | $\\mu_{h} = \\frac{\\tau_{h}}{N_{h}}$                                     | $\\bar{y}_{h} = \\frac{1}{n_{h}}\\sum_{j} y_{hj}$              |\n| Overall mean              | $\\mu = \\frac{\\tau}{N}$                                                 | $\\bar{y}_{str} = \\sum_{h} \\frac{N_{h}}{N}\\bar{y}_{h}$ |\n| Variance of the mean     | $\\sigma_{h}^2 = \\frac{1}{N_{h}-1}\\sum_{j=1}^{N_{h}}(y_{hj}-\\mu_{h})^2$ | $s_{h}^2 = \\frac{1}{n_{h}-1}\\sum_{j}(y_{hj}-\\bar{y}_{h})^2$ |\n| Proportion in strata| $p_{h} = \\mu_h$ | $\\bar{y}_h = \\hat{p}_h$ |\n| Variance of $p_{h}$ | $\\sigma_h^2=\\frac{N_h}{N_h-1} p_h(1-p_h)$ | $s_h^2=\\frac{n_h}{n_h-1} \\hat{p}_h(1-\\hat{p}_h)$ |\n| Overall proportion | $p = \\sum_{h} \\frac{N_h}{N} p_h$ | $\\hat{p}_{str} = \\sum_{h} \\frac{N_h}{N}\\hat{p}_h$  |\n\n\n## Explanations\n\n\n| Measure                   | Population $(\\theta)$                                                  | Sample $(\\hat{\\theta})$                                     |\n|------------------|-----------------------------|-----------------------------|\n| Sample size in strata $h$ | number of population units in stratum h                                                                | sample size taken in stratum h                                                     |\n| Overall sample size       | total population size, from all strata                                             | total sample size, from all strata                                  |\n| Total in strata $h$       | population total in strata h                                 | estimated population total in stratum h                           |\n| Overall total             | population total                                        |estimated population total         |\n| Mean in strata $h$        | population mean in strata h                                     | sample mean in stratum h              |\n| Overall mean              | population mean                                                 | weighted average of the sample stratum means |\n| Variance  of the mean   | population variance in stratum h  | sample variance in stratum h |\n| Proportion in strata $h$    |  |  |\n| Variance of proportion   |  |  |\n| Overall proportion   |  |  |\n\n:::\n\n\nMisc additional equations; \n\n* Estimated variance of population total $\\hat{V}(\\hat{\\tau}_{str}) = \\sum_{h} (1-\\frac{n_h}{N_h})N^2 \\frac{s^2_h}{n_h}$\n* Estimated variance of population proportion $\\hat{V}(\\hat{p}_{str}) = \\sum_{h} (1-\\frac{n_h}{N_h}) (\\frac{N_h}{N})^2 \\frac{\\hat{p}_h (1-\\hat{p}_h)}{n_h-1}$\n* Estimated total number of population units having a specified characteristic: $\\hat{t}_{str} = \\sum_{h} N_h \\hat{p}_h$, with variance $N^2\\hat{V}(\\hat{p}_{str})$. \n\n## Confidence Interval for Stratified Random Sample\n\nIf either the sample sizes within each stratum are large or the sampling design has a large number of strata, then the confidence interval for the population mean $\\bar{y}\\mu$ is: \n\n$$ \\bar{y}_{str}= \\pm z_{\\alpha /2 } SE (\\bar{y}_{str})$$\n\nHowever, most survey packages use a $t_{n-H}$ distribution instead of using the normal assumption. \n\n:::{.callout-tip icon=true}\n### Example: Estimate the total number of farm acres in 1992 (Table 3.2)\nThe best way to understand an equation, is to try to use it in a calculation. \n:::\n\n1. Calculate summary statistics for each region. _This was seen earlier as `new_table3.1`_\n\n::: {.cell}\n\n```{.r .cell-code}\nstrata.summary.stats <- agstrat %>% \n   group_by(region) %>% \n   summarize(y.bar.h = mean(acres92),\n             s2.h    = var(acres92),\n             n.h     = n()) \n```\n:::\n\n\n2. Calculate Population region sizes, add this vector to the data frame created above.\n\n::: {.cell}\n\n```{.r .cell-code}\n(region.size <- agpop %>% group_by(region) %>% tally())\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 4 × 2\n  region     n\n  <chr>  <int>\n1 NC      1054\n2 NE       220\n3 S       1382\n4 W        422\n```\n:::\n\n```{.r .cell-code}\nstrata.summary.stats$N.h <- region.size$n\nstrata.summary.stats\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 4 × 5\n  region y.bar.h          s2.h   n.h   N.h\n  <chr>    <dbl>         <dbl> <int> <int>\n1 NC     300504.  29618183543.   103  1054\n2 NE      97630.   7647472708.    21   220\n3 S      211315.  53587487856.   135  1382\n4 W      662296. 396185950266.    41   422\n```\n:::\n:::\n\n\n3. Calculate the sample total $\\hat{\\tau}_{h} = N_{h}\\bar{y_h}$.\n\n::: {.cell}\n\n```{.r .cell-code}\nstrata.summary.stats$tau.hat.h <- strata.summary.stats$y.bar.h * strata.summary.stats$N.h\nstrata.summary.stats\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 4 × 6\n  region y.bar.h          s2.h   n.h   N.h  tau.hat.h\n  <chr>    <dbl>         <dbl> <int> <int>      <dbl>\n1 NC     300504.  29618183543.   103  1054 316731380.\n2 NE      97630.   7647472708.    21   220  21478558.\n3 S      211315.  53587487856.   135  1382 292037391.\n4 W      662296. 396185950266.    41   422 279488706.\n```\n:::\n:::\n\n\n4. Calculate the within-strata variance of this total $\\Big(1 - \\frac{n_{h}}{N_{h}}\\Big)N^{2}_{h}\\frac{s^{2}_{h}}{n_{h}}$.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstrata.summary.stats <- strata.summary.stats %>%\n  mutate(var.tau.hat.h = \n           (1 - n.h/N.h)*(N.h^2)*(s2.h/n.h)\n  )\nstrata.summary.stats\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 4 × 7\n  region y.bar.h          s2.h   n.h   N.h  tau.hat.h var.tau.hat.h\n  <chr>    <dbl>         <dbl> <int> <int>      <dbl>         <dbl>\n1 NC     300504.  29618183543.   103  1054 316731380.       2.88e14\n2 NE      97630.   7647472708.    21   220  21478558.       1.59e13\n3 S      211315.  53587487856.   135  1382 292037391.       6.84e14\n4 W      662296. 396185950266.    41   422 279488706.       1.55e15\n```\n:::\n:::\n\n\n5. Calculate the overall total $\\hat{\\tau}_{str}$ and variance $\\hat{V}\\big(\\hat{\\tau}_{str}\\big)$ by summing these values across the strata.\n\n::: {.cell}\n\n```{.r .cell-code}\n(tau.hat.str <- sum(strata.summary.stats$tau.hat.h))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 909736035\n```\n:::\n\n```{.r .cell-code}\n(V.tau.hat.str <- sum(strata.summary.stats$var.tau.hat.h))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 2.541899e+15\n```\n:::\n:::\n\n\nThe estimated total number of acres devoted to farming is 909,736,035, with standard error 50,417,248. These numbers match those found in Table 3.2.  \n\n:::{.callout-warning icon=false}\n### :star: You try it\nSiniff and Skoog (1964) used stratified random sampling to estimate the size of a herd of Alaskan caribou in 1992. Using known density estimates, the researches divided the area into 6 strata, each of 4 sq miles. The summary information from each strata is contained in the table below. \n\n::: {.cell}\n::: {.cell-output-display}\n|Stratum | N.h| n.h| y.bar.h|   s2.h|\n|:-------|---:|---:|-------:|------:|\n|A       | 400|   8|    24.1|   5575|\n|B       |  30|  10|    25.6|   4064|\n|C       |  61|  37|   267.6| 347556|\n|D       |  18|   6|   179.0|  22798|\n|E       |  70|  39|   293.7| 123578|\n|F       | 120|  21|    33.2|   9795|\n:::\n:::\n\n\nUse this information and the equations from this chapter to calculate the estimated total number of caribou in this region in Alaska. \n:::\n\n:::{.callout-warning icon=false collapse=\"true\" appearance=minimal}\n### Solution\n\n\nThis CI only explains uncertainty due to sampling error, if researchers tend to miss animals, this CI will be low\n\n:::\n\n\n:::{.callout-warning icon=false}\n### :star: You try it\nThe ACLS intends to use a stratified random sample to study publications and library use among members. They divide their data into discipline, making 7 stratas. \n\nUse the summary table below to estimate the the percentage and number of respondents that are female in those seven disciplines. \n\n\n::: {.cell}\n::: {.cell-output-display}\n| Membership | Valid.Returns | Female.members |\n|:----------:|:-------------:|:--------------:|\n|    9100    |      636      |      0.38      |\n|    1950    |      451      |      0.27      |\n|    5500    |      481      |      0.18      |\n|   10850    |      611      |      0.19      |\n|    2100    |      493      |      0.36      |\n|    5500    |      575      |      0.13      |\n|    9000    |      588      |      0.26      |\n:::\n:::\n\n:::\n\n\n:::{.callout-warning icon=false collapse=\"true\" appearance=minimal}\n### Solution\n\nCreate the within stratum total and variances. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nNh <- c(9100,1950,5500,10850,2100,5500,9000)\nnh <- c(636,451,481,611,493,575,588)\nph <- c(.38,.27,.18,.19,.36,.13,.26)\nN <- sum(Nh)\n```\n:::\n\n\n\nThe overall estimated proportion of female members in the societies is calculated as \n\n::: {.cell}\n\n```{.r .cell-code}\n(p.str = sum((Nh/N)*ph))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 0.2465227\n```\n:::\n:::\n\nwith variance....\n\n\nThe total number of female members in this society is calculate as\n\n::: {.cell}\n\n```{.r .cell-code}\nN*p.str\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 10847\n```\n:::\n:::\n\n\nThere are 10,847 female members.\n\n:::\n\n",
    "supporting": [
      "cn06-stratified_sampling_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}