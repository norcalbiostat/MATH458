{
  "hash": "f58ac24fd7f59114ef80c35e6eb7717b",
  "result": {
    "markdown": "---\ntitle: \"Formulas and Definitions\"\ndescription: \"Equations and R code\"\ndate: \"2023-01-20\"\n---\n\n\n# Parameters and Statistics\n\n| Measure        | Population $(\\theta)$                             | Sample $(\\hat{\\theta})$                            |\n|------------------|--------------------------|---------------------------|\n| Total          | $\\tau = \\sum_{i=1}^N y_{i}$                       | $\\hat{\\tau} = \\sum_{i=1}^n y_{i}$                  |\n| Mean           | $\\mu = \\frac{1}{N}\\sum_{i=1}^N y_{i}$             | $\\bar{y} = \\frac{1}{n}\\sum_{i=1}^n y_{i}$          |\n| Variance       | $\\sigma^2 = \\frac{1}{N}\\sum_{i=1}^{N}(y_i-\\mu)^2$ | $s^2 = \\frac{1}{n-1}\\sum_{i=1}^{n}(y_i-\\bar{y})^2$ |\n| Proportion$^*$ | $p = \\mu$                                         | $\\hat{p} = \\bar{y}$                                |\n\n-   $N$ = total population size\n\n-   $y_{i}$ = Value of measurement $y$ on unit $i$\n\n-   $^*$For proportions $y_{i}$ is a binary indicator of success. $y \\in {[0,1]}$. I.e. $I(y_{i}=1)$.\n\n## Expected Value and Variance of estimates\n\n$$E(\\hat{\\theta}) = \\sum\\hat{\\theta}*p(\\hat{\\theta}) \\qquad \\qquad V(\\hat{\\theta}) = \\sum [\\hat{\\theta} - E(\\hat{\\theta})]^2*p(\\hat{\\theta})$$\n\n-   Sums are over all possible values of $\\hat{\\theta}$.\n-   $p(\\hat{\\theta})$ is the probability of $\\hat{\\theta}$ occurring.\n    -   This is similar to what we're calling $\\delta_{i}$, the probability that population unit $i$ appears in the sample. The book uses the symbol $\\pi_{i}$\n\n----\n\n# Weighted Estimators for Probability sampling designs\n\nSurvey weights can be used in all probability sampling designs and calculated as the reciprocal of the inclusion probability $\\delta_{i}$. Weights $w_{i}$ are applied directly to the data value $y$ before use in any formulas. \n\n\n|         Population size         |                  Total                  |                  Mean                  |\n|:-----------------------:|:-------------------:|:-------------------------:|\n| $\\hat{N} = \\sum_{i \\in S}w_{i}$ | $\\hat{\\tau} = \\sum_{i \\in S}w_{i}y_{i}$ | $\\bar{y} = \\frac{\\hat{\\tau}}{\\hat{N}}$ |\n\n\n* **SRS**: $w_{i} =\\frac{N}{n}$\n* **Stratified**: $w_{hj}=\\frac{N_h}{n_h}$\n* **One stage cluster**: is an SRS of clusters.\n* **Two stage cluster**: $w_{ij} = \\frac{N}{n}\\frac{M_{i}}{m_{i}}$\n    - Stage 1: $P$($i$th psu selected) = $\\frac{n}{N}$\n    - Stage 2: $P$($j$th ssu selected | $i$th psu selected) = $\\frac{m_i}{M_i}$\n\n----\n\n# Estimators under different Sampling Designs\n\n## Simple Random Sample\n\n| Measure    | Unbiased Estimate $(\\hat{\\theta})$         | Estimated variance of $(\\hat{\\theta})$                             |\n|------------------|---------------------|---------------------------------|\n| Mean       | $\\bar{y} = \\frac{1}{n}\\sum_{i\\in S} y_{i}$ | $\\hat{V}(\\bar{y}) = (1-\\frac{n}{N})\\frac{s^{2}}{n}$                |\n| Total      | $\\hat{\\tau} = N\\bar{y}$                    | $\\hat{V}(\\hat{\\tau}) = N^{2}\\hat{V}(\\bar{y})$                      |\n| Proportion | $\\hat{p} = \\bar{y}$                        | $\\hat{V}(\\hat{p}) = (1-\\frac{n}{N})\\frac{\\hat{p}(1-\\hat{p})}{n-1}$ |\n\n-   $i \\in S$ : Unit $i$ is an element in the sample $S$\n-   $(1-\\frac{n}{N})$: Finite population correction (fpc)\n\n\n## Stratified Random Sample\n\n* CI's should use a $t_{n-H}$ distribution instead of using the normal assumption. \n\n| Measure                   | Population $(\\theta)$                                                  | Sample $(\\hat{\\theta})$                                     |\n|------------------|-----------------------------|-----------------------------|\n| Sample size in strata $h$ | $N_{h}$                                                                | $n_{h}$                                                     |\n| Overall sample size       | $N = \\sum^{H}_{h=1} N_{h}$                                             | $n = \\sum^{H}_{h=1} n_{h}$                                  |\n| Var(y) in strata $h$    | $\\sigma_{h}^2 = \\frac{1}{N_{h}-1}\\sum_{j=1}^{N_{h}}(y_{hj}-\\mu_{h})^2$ | $s_{h}^2 = \\frac{1}{n_{h}-1}\\sum_{j}(y_{hj}-\\bar{y}_{h})^2$ |\n| Total in strata $h$       | $\\tau_{h} = \\sum_{j=1}^{N_{h}} y_{hj}$                                 | $\\hat{\\tau}_{h} = N_{h}\\bar{y_h}$                           |                         |\n| Overall total             | $\\tau = \\sum_{h=1}^{H} \\tau_{h}$                                       | $\\hat{\\tau}_{str} = \\sum_{h=1}^{H}N_{h}\\bar{y}_{h}$         |\n| Mean in strata $h$        | $\\mu_{h} = \\frac{\\tau_{h}}{N_{h}}$                                     | $\\bar{y}_{h} = \\frac{1}{n_{h}}\\sum_{j} y_{hj}$              |\n| Overall mean              | $\\mu = \\frac{\\tau}{N}$                                                 | $\\bar{y}_{str} = \\sum_{h=1}^{H} \\frac{N_{h}}{N}\\bar{y}_{h}$ |\n| Proportion in strata $h$ | $p_{h} = \\mu_h$ | $\\bar{y}_h = \\hat{p}_h$ |\n| Variance of $p_{h}$ | $\\sigma_h^2=\\frac{N_h}{N_h-1} p_h(1-p_h)$ | $s_h^2=\\frac{n_h}{n_h-1} \\hat{p}_h(1-\\hat{p}_h)$ |\n| Overall proportion | $p_{str} = \\sum_{h=1}^{H} \\frac{N_h}{N} p_h$ | $\\hat{p}_{str} = \\sum_{h=1}^{H} \\frac{N_h}{N}\\hat{p}_h$  |\n\nEstimated variances; \n\n* Within strata total $\\hat{V}(\\hat{\\tau}_{h}) = (1-\\frac{n_h}{N_h})N^2 \\frac{s^2_h}{n_h}$  \n* Within strata mean  $\\hat{V}(\\bar{y}_{h}) = \\frac{1}{N^2}V(\\hat{\\tau}_{h})$\n* Overall population total $\\hat{V}(\\hat{\\tau}_{str}) = \\sum_{h=1}^H (1-\\frac{n_h}{N_h})N^2 \\frac{s^2_h}{n_h}$\n* Population proportion $\\hat{V}(\\hat{p}_{str}) = \\sum_{h=1}^H (1-\\frac{n_h}{N_h}) (\\frac{N_h}{N})^2 \\frac{\\hat{p}_h (1-\\hat{p}_h)}{n_h-1}$\n* Estimated total number of population units having a specified characteristic: $\\hat{t}_{\\it{str}} = \\sum_{h=1}^H N_h \\hat{p}_h$\n\n## Cluster Random Sample\n\n\n::: panel-tabset\n## Pop psu level\n\n| Symbol      | Formula                                                          | Description                                    |\n|------------|--------------------------|----------------------------------------|\n| $y_{ij}$    |                                                                  | measurement for the $j$th element in $i$th psu |\n| $N$         |                                                                  | number of clusters (psus) in the population    |\n| $M_{i}$     |                                                                  | number of ssus in psu $i$                      |\n| $M_{0}$     | $\\sum_{i=1}^{N} M_{i}$                                           | total number of ssus in the population         |\n| $t_{i}$     | $\\sum_{j=1}^{M_{i}} y_{ij}$                                      | total in psu $i$                               |\n| $t$         | $\\sum_{i=1}^{N} t_{i}= \\sum_{i=1}^{N} \\sum_{j=1}^{M_{i}} y_{ij}$ | population total                               |\n| $S_{t}^{2}$ | $\\frac{1}{N-1} \\sum_{i=1}^{N} (t_{i} - \\frac{t}{N})^2$           | population variance of the psu totals          |\n\n## Pop ssu level\n\n| Symbol           | Formula                                                                  | Description                        |\n|-------------------|-----------------------------------|-------------------|\n| $\\bar{y}_{\\mu}$  | $\\frac{1}{M_0} \\sum_{i=1}^N \\sum_{j=1}^{M_i} y_{ij}$                     | population mean                    |\n| $\\bar{y}_{i\\mu}$ | $\\frac{1}{M_i} \\sum_{j=1}^{M_i} y_{ij} = \\frac{t_i}{M_i}$                | population mean in psu $i$         |\n| $S^2$            | $\\frac{1}{M_0-1} \\sum_{i=1}^N \\sum_{j=1}^{M_i} (y_{ij}-\\bar{y}_{\\mu})^2$ | population variance (per ssu)      |\n| $S_{i}^{2}$      | $\\frac{1}{M_i-1} \\sum_{j=1}^{M_i} (y_{ij}-\\bar{y}_{\\mu})^2$              | population variance within psu $i$ |\n\n## Sample\n| Symbol                   | Formula                                                  | Description                                     |\n|------------------|-----------------------------|-----------------------------|\n| $y_{ij}$ |                                                                |Measurement for$j$th element in $i$ht psu                                             |\n|$N$||Number of clusters (psus) in the population|\n|$M_i$||Number of ssus in psu $i$|\n|$M_{o}$|$\\sum_{i=1}^NM_i$|Total number of psus in the popultion|\n|$t_i$|$\\sum_{j=1}^{M_i}y_{ij}$|Total in psu $i$|\n|$t$|$\\sum_{i=1}^Nt_i = \\sum_{i=1}^N\\sum_{j=i}^{M_i}y_{ij}$|Popultion Total|\n|$S_i^2$|$\\frac{1}{N-1} \\sum_{i=1}^N(t_i-\\frac{t}{N})^2$|Popultion variance of the psu totals|\n\n:::\n\n## Ratio Estimation in SRS\n\nLet $y_{i}$ be the measure of interest, and $x_{i}$ be the auxiliary variable. In a population of size $N$ the totals for each measure are\n\n$$\nt_{y} = \\sum_{i=1}^Ny_{i} \\qquad t_{x} = \\sum_{i=1}^Nx_{i}\n$$\n\nand their ratio is calculated as\n$$\nB = \\frac{t_{y}}{t_{x}} = \\frac{\\mu_{y}}{\\mu_{x}}.\n$$\n\n## Regression Estimation in SRS\n\nRegression estimation uses the method of ordinary least squares to calculate estimates for the slope $B_1$ and intercept $B_{0}$ of a 'line of best fit' between the outcome measure of interest $y$ and the auxiliary variable $x$. \n\n$$\ny = B_0 + B_1x\n$$\n\nwhere\n\n$$\n\\hat{B}_1 = \\frac{rs_y}{s_x} \\qquad \\hat{B}_0 = \\bar{y} - \\hat{B}_1\\bar{x}\n$$\n\nwhere $r$ is the sample correlation coefficient between $x$ and $y$, and $s_x$ and $s_y$ are sample standard deviations of $x$ and $y$ respectively. \n\n\n----\n\n# R commands \n\nThis is a quick reference list. See the R companion for the textbook, the `survey` package help file or vignette for more information. \n\n## Specify survey design `svydesign`\n\n* Function call: `svydesign(id = , weights=,  fpc= , data = )`\n* `id` = variable that identifies clusters \n* `weights` = variable that holds the sampling weights\n* `fpc` = finite population correction. Typically defined in the function call. \n\n\nThe argument details can be found on the specified pages in the R companion for the book. \n\n* SRS: pg 21\n* Stratified Random Sample: pg 34\n* Cluster sampling: \n* Ratio estimates: pg 41\n* Regression estimates: pg 44\n\n## Estimators\n\n* **mean**: `svymean(~x, design)`\n* **total**: `svytotal(~x, design)`\n* **proportion**: Use `svytotal` and divide by `N`\n* **CI for the mean or total**: Use `confint()` after calculating the point estimate\n* **CI for proportion**: `svyciprop(~x, design)` Will also print out $\\hat{p}$\n* **Ratio estimate**: `svyratio(~numerator, ~denominator, design)`\n* **Regression estimate**: `svyglm(y~x, design)`\n\n## Calculating stratum means and variances\n\n* The first argument of `svyby` is the formula for the variable(s) for which\nstatistics are desired\n* `(by=)` is the variable that defines the groups.\n* Then list the `design` object\n* and the name of the function that calculates the statistics. \n* Set `keep.var=TRUE` to display the standard errors for the statistics.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsvyby(~acres92, by=~region, agstrat.dsgn, svytotal, keep.var = TRUE)\n```\n:::\n\n\n# Manage data collection \n\nSetup a data collection sheet using random sampling from a sampling frame\n\n1. Setup your sampling frame in a spreadsheet. [See this example using google sheets](https://docs.google.com/spreadsheets/d/1L0voUNhw5CsZ3YPWsuTJCBYm963L0zFIhDKS5HUjmms). \n2. Import your sampling frame into R. More info can be found on the [googlesheets4](https://googlesheets4.tidyverse.org/articles/googlesheets4.html) package vignette. \n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(googlesheets4)\nsheet.url <- \"https://docs.google.com/spreadsheets/d/1L0voUNhw5CsZ3YPWsuTJCBYm963L0zFIhDKS5HUjmms\"\nframe.srs <- read_sheet(sheet.url, sheet = \"srs\") \nframe.str <- read_sheet(sheet.url, sheet = \"stratified\") \nframe.clu <- read_sheet(sheet.url, sheet = \"cluster\") \n```\n:::\n\n\n3. Use functions from the `sampling` package to draw random samples according to your design. See the links for more details on what the arguments mean. \n\n* [SRS](https://sampling-458.netlify.app/notes/cn04-srs#drawing-a-srs-using-a-computer).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(sampling)\nset.seed(12345)\nsrs.idx <- srswor(8, length(frame.srs$unit_id)) \ngetdata(frame.srs, srs.idx)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n  ID_unit unit_id\n1       2       2\n2       6       6\n3       8       8\n4      11      11\n5      14      14\n6      16      16\n7      18      18\n8      19      19\n```\n:::\n:::\n\n\n\n* [Stratified](https://sampling-458.netlify.app/notes/cn06-stratified_sampling.html#using-r)\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(dplyr)\nframe.str <- frame.str %>% arrange(group) # sort first\nstrata.idx <- sampling::strata(data = frame.str,      # data set\n                 stratanames = \"group\", # variable name\n                 size = c(6,4,5),      # stratum sample sizes     \n                 method = \"srswor\")     # method for selecting within strata\ngetdata(frame.str, strata.idx)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n   unit_id group ID_unit      Prob Stratum\n1        1     A       1 0.5454545       1\n2        2     A       2 0.5454545       1\n6        6     A       6 0.5454545       1\n7        7     A       7 0.5454545       1\n10      10     A      10 0.5454545       1\n11      11     A      11 0.5454545       1\n12       1     B      12 0.5000000       2\n17       6     B      17 0.5000000       2\n18       7     B      18 0.5000000       2\n19       8     B      19 0.5000000       2\n21       2     C      21 0.8333333       3\n22       3     C      22 0.8333333       3\n23       4     C      23 0.8333333       3\n24       5     C      24 0.8333333       3\n25       6     C      25 0.8333333       3\n```\n:::\n:::\n\n\n* One stage cluster\n\n::: {.cell}\n\n```{.r .cell-code}\nonestage.idx <- sampling::cluster(data=frame.clu,         # Data set\n                  clustername = \"group\",  # variable name containing clusters \n                  size = 3,               # number of clusters\n                  method = \"srswor\",      # how to draw clusters \n                  description = TRUE)     # show descriptive output\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nNumber of selected clusters: 3 \nNumber of units in the population and number of selected units: 50 25 \n```\n:::\n\n```{.r .cell-code}\ngetdata(frame.clu, onestage.idx)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n   unit_id group ID_unit Prob\n1        3     A       3  0.6\n2        1     A       1  0.6\n3        2     A       2  0.6\n4        7     A       7  0.6\n5        4     A       4  0.6\n6        5     A       5  0.6\n7        6     A       6  0.6\n8        5     B      12  0.6\n9        1     B       8  0.6\n10       2     B       9  0.6\n11       3     B      10  0.6\n12       4     B      11  0.6\n13       9     B      16  0.6\n14       6     B      13  0.6\n15       7     B      14  0.6\n16       8     B      15  0.6\n17      10     B      17  0.6\n18       8     C      25  0.6\n19       1     C      18  0.6\n20       2     C      19  0.6\n21       3     C      20  0.6\n22       4     C      21  0.6\n23       5     C      22  0.6\n24       6     C      23  0.6\n25       7     C      24  0.6\n```\n:::\n:::\n\n\n\n\n* Two stage cluster\n\n::: {.cell}\n\n```{.r .cell-code}\nmstage.idx <- sampling::mstage(data=frame.clu, \n                 stage = c(\"cluster\", \"\"),  # sampling method for each stage, blank means SRS\n                 varnames = list(\"group\", \"unit_id\"),  # variable names for each stage\n                 size = list(3, c(5,5,5)), # 3 psus, 5 ssus from each psu\n                 method = c(\"srswor\", \"srswor\"))\n\ngetdata(frame.clu, mstage.idx)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[[1]]\n   unit_id group ID_unit Prob_ 1 _stage\n1        6     B      13            0.6\n2       10     B      17            0.6\n3        7     B      14            0.6\n4        8     B      15            0.6\n5        9     B      16            0.6\n6        1     B       8            0.6\n7        2     B       9            0.6\n8        3     B      10            0.6\n9        4     B      11            0.6\n10       5     B      12            0.6\n11       1     D      26            0.6\n12       2     D      27            0.6\n13       3     D      28            0.6\n14       4     D      29            0.6\n15       5     D      30            0.6\n16       6     D      31            0.6\n17       7     D      32            0.6\n18       8     D      33            0.6\n19       9     D      34            0.6\n20      10     D      35            0.6\n21      11     D      36            0.6\n22      12     D      37            0.6\n23      13     D      38            0.6\n24       1     E      39            0.6\n25       2     E      40            0.6\n26       3     E      41            0.6\n27       4     E      42            0.6\n28       5     E      43            0.6\n29       6     E      44            0.6\n30       7     E      45            0.6\n31       8     E      46            0.6\n32       9     E      47            0.6\n33      10     E      48            0.6\n34      11     E      49            0.6\n35      12     E      50            0.6\n\n[[2]]\n   group unit_id ID_unit Prob_ 2 _stage      Prob\n1      B      10      17      0.5000000 0.3000000\n2      B       7      14      0.5000000 0.3000000\n3      B       8      15      0.5000000 0.3000000\n4      B       2       9      0.5000000 0.3000000\n5      B       3      10      0.5000000 0.3000000\n6      D       4      29      0.3846154 0.2307692\n7      D       6      31      0.3846154 0.2307692\n8      D       8      33      0.3846154 0.2307692\n9      D       9      34      0.3846154 0.2307692\n10     D      13      38      0.3846154 0.2307692\n11     E       1      39      0.4166667 0.2500000\n12     E       3      41      0.4166667 0.2500000\n13     E       5      43      0.4166667 0.2500000\n14     E       7      45      0.4166667 0.2500000\n15     E       9      47      0.4166667 0.2500000\n```\n:::\n:::\n\n\nSee `?mstage` for more examples of multistage sampling. \n\n4. Make a new spreadsheet containing the sampled rows, and add a column for $y$ the thing you are going to measure on each unit. \n\n5. Go collect data! \n\n\n## Other R help References\n\n-   [`survey` package vignette](http://r-survey.r-forge.r-project.org/survey/)\n-   [The Epidemiologist R handbook](https://epirhandbook.com/en/survey-analysis.html)\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}